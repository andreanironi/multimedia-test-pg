"use strict";var efsaPesticideDatavizConfig={colors:["#31b7d2","#71c17c","#e7799e","#f8c25e","#8a428c","#acc25d","#7a7c7f"],donut:{color_1:"#00a690",color_2:"#4cc4a9",color_3:"#de4a7a"},gray:"#a8a8a8",all_foods:"#85746c"};var mobile=q.mobilecheck();var RESIZE_TOLERANCE=70;function efsaPesticideDataviz(config){var FORCE_REFRESH=false;var LANGUAGES=["en","it","fr","de"];var urlLang=extractURLLanguage();var lang=urlLang||(config.lang||(navigator.language&&navigator.language.split("-")[0]||"en"));if(LANGUAGES.indexOf(lang)<0){lang="en"}window.efsaPesticideDatavizLang=lang;var TIME=config.time||(mobile?200:320);var DONUT_COLOR_1=config.donut.color_1||"#30807c";var DONUT_COLOR_2=config.donut.color_2||"#4cbf85";var DONUT_COLOR_3=config.donut.color_3||"#c34a2d";var colors=config.colors||["#00aac0","#7baa52","#f27f89","#e8b469","#8e3392","#98935c","#7a7c7f"];var GRAY=config.gray||"#a8a8a8";var COUNTRIES_BUBBLES_COLOR="#00626d";var COUNTRIES_CODE_COLOR="white";var dictionary=i18n(lang);q.fastclick();var t=q.speedtest();var speedClass=q.ceil(t/10);var CATEGORY=1;var SUBCATEGORY=2;var ITEM=3;var savedNodes=null;var circle;var hiddenCircle;var hiddenText,hiddenButton,hiddenButtonText;var hiddenValue;var hiddenValueLegend;var gCircles,gCompositionChart,gHiddenCircle,gTabs,gSubtabs,gTooltip,gHiddenCircleCircle,gHiddenCircleArcs;var gHiddenCircleContentDonut,gHiddenCircleContentPie,gHiddenCircleContentCountry;var svg=d3.select("#efsa-pesticide-dataviz-svg");var width=svg.node().clientWidth||parseInt(window.getComputedStyle(svg.node()).width),height=svg.node().clientHeight||parseInt(window.getComputedStyle(svg.node()).height);svg.attr("viewBox","0 0 "+width+" "+height);svg.selectAll("*").remove();var tabWidth=q.round(width/18.776);var maxTabWidth=0;var DEFAULT_TAB_HEIGHT_RATIO=31;var tabHeight=q.round(height/DEFAULT_TAB_HEIGHT_RATIO);var tabSpace=mobile?1:2;var subtabWidth=q.round(width/4.8);var tabOpen=null;var shifting=false,leftShifted=false,faked=-1,shown=-1,unshowing=false,expanded=false,compositionChartDonutExpanded=false;var donutShown=false,pieShown=false;var lastHovered;var lastBubbleClickTime=0;var expandedName=-1,expandedType=null;var readyToUser=false;var RIGHT_TABS_Y=height/3.85-tabHeight;var SEMITRANSPARENT=.15;var CLICKED_RADIUS=null;var EXPANDED_RADIUS=height/3.75;if(width>1500){EXPANDED_RADIUS+=20}var SUBCATEGORIES_TO_SHOW=null;var COUNTRIES_BUBBLE_STROKE_WIDTH=.25;var COUNTRIES_BUBBLE_STROKE="#a0a0a0";var KEEP_MENU_OPEN_ONCE_MORE=false;var lastHiddenValue=0;var touchStart=0;var COUNTRIES_SPECIES_TYPES=["Domestic","EU","TC","UN"];var FONT_BIG=Math.min(q.round(height/45),q.round(width/70));if(FONT_BIG<6){FONT_BIG=6}var FONT_NORMAL=q.round(FONT_BIG*.8);if(FONT_BIG>16.5){FONT_BIG=16.5}if(FONT_NORMAL>13){FONT_NORMAL=13}var isIE=navigator.userAgent.indexOf("Trident")>-1;var isFF=navigator.userAgent.indexOf("Firefox")>-1;var isSaf=navigator.userAgent.indexOf("Safari")>-1&&navigator.userAgent.indexOf("Chrome")<0;var ds=q.getDecimalSeparator(lang);var ths=ds==="."?",":".";var sideData1=[];var sideData2=[];var sideData3=[];function read(file,callback){d3.request(file).mimeType("text/plain").response(function(xhr){return d3.dsvFormat(";").parse(xhr.responseText)}).get(function(data){callback(data)})}function readFoods(callback){read("https://www.efsa.europa.eu/sites/default/files/interactive_tools/pesticides_2017/data/food.csv",callback)}function readCountries(callback){read("https://www.efsa.europa.eu/sites/default/files/interactive_tools/pesticides_2017/data/results-by-country.csv",function(res){for(var r in res){var rec=res[r];if(rec.name){sideData1[rec.name]={value_below_loq:+rec["%below LOQ"],value_below_mrl:+rec["%betweenLOQ_MRL"],value_above_mrl:+rec["%aboveLOQ"]}}}read("https://www.efsa.europa.eu/sites/default/files/interactive_tools/pesticides_2017/data/results-by-origin.csv",function(res){for(var r in res){var rec=res[r];if(rec.name){sideData2[rec.name]={value_below_loq:+rec["%belowLOQ"],value_below_mrl:+rec["%betweenLOQ_MRL"],value_above_mrl:+rec["%aboveLOQ"]}}}read("https://www.efsa.europa.eu/sites/default/files/interactive_tools/pesticides_2017/data/origin-of-sample.csv",function(res){for(var r in res){var rec=res[r];if(rec.name){sideData3[rec.name]={dom:+rec.dom,eu:+rec.eu,tc:+rec.tc,un:+rec.un}}}read("https://www.efsa.europa.eu/sites/default/files/interactive_tools/pesticides_2017/data/country.csv",callback)})})})}function doFoods(){tabHeight=q.round(height/DEFAULT_TAB_HEIGHT_RATIO);savedNodes=null;d3.select("#efsa-pesticide-loading").style("display","block").style("background-color","rgba(245,245,245,.5)");readFoods(function(data){var categories=[];var subcategories=[];var foods=[];var samples={};var longest=0;_.each(data,function(item){var category=item.Category;var subcategory=item.SubCategory;var itemsamples=+item.Samples;categories.push({name:category,subcategory:null});subcategories[category]=subcategories[category]?subcategories[category]:[];subcategories[category].indexOf(subcategory)<0?subcategories[category].push(subcategory):null;samples["cat-"+category]=samples["cat-"+category]?samples["cat-"+category]:0;samples["subcat-"+subcategory]=samples["subcat-"+subcategory]?samples["subcat-"+subcategory]:0;samples["cat-"+category]+=itemsamples;samples["subcat-"+subcategory]+=itemsamples;foods.push({name:item.Food,subcategory:subcategory,category:category,value:itemsamples,value_below_loq_as_samples:item["Below LOQ"],value_below_mrl_as_samples:item["Below MRL"],value_above_mrl_as_samples:item["Above MRL"],value_below_loq:item["% Below LOQ"],value_below_mrl:item["% Below MRL"],value_above_mrl:item["% Above MRL"]});if(subcategory.length>longest){longest=subcategory.length}});subtabWidth=longest*FONT_NORMAL/1.7;subtabWidth=Math.max(maxTabWidth+30,subtabWidth);categories=_.uniq(_.map(categories,function(p){return p.name}));dataviz(categories,subcategories,foods,samples,"food")})}window.doFoods=function(){doFoods()};function doCountries(){savedNodes=null;tabHeight=q.round(height/DEFAULT_TAB_HEIGHT_RATIO);tabHeight*=1.3;d3.select("#efsa-pesticide-loading").style("display","block").style("background-color","rgba(245,245,245,.5)");readCountries(function(data){var categories=[];var subcategories=[];var foods=[];var samples={};var summedData=[];var composition={};_.each(data,function(item){var country=item.country;if(!summedData[country]){summedData[country]={name:country,countrycode:item.code,inhabitants:item.inhabitants,samples:0}}summedData[country].samples+=+item.samples;composition[item.country]=composition[item.country]?composition[item.country]:[];composition[item.country].push({country:item.refcountry,type:item.type,samples:+item.samples})});categories=["countries"];subcategories["countries"]=[];var longest=0;for(var i in summedData){var item=summedData[i];var name=item.name;var value=+item.samples;subcategories["countries"].push(name);foods.push({name:name,countrycode:item.countrycode,subcategory:name,category:"countries",value:value,value_below_loq:sideData1[name].value_below_loq,value_below_mrl:sideData1[name].value_below_mrl,value_above_mrl:sideData1[name].value_above_mrl,samples:value,inhabitants:+item.inhabitants});if(name.length>longest){longest=name.length}samples["cat-"+"countries"]=samples["cat-"+"countries"]?samples["cat-"+"countries"]:0;samples["subcat-"+name]=samples["subcat-"+name]?samples["subcat-"+name]:0;samples["cat-"+"countries"]+=value;samples["subcat-"+name]+=value;samples["subcat-"+name+"-inhabitants"]=+item.inhabitants}subtabWidth=longest*FONT_NORMAL/2+30;subtabWidth=Math.max(maxTabWidth+30,subtabWidth);samples.composition=composition;dataviz(categories,subcategories,foods,samples,"country")})}window.doCountries=function(){doCountries()};function initSVG(){svg.selectAll("*").remove();gCircles=svg.append("g").attr("opacity","0");gCompositionChart=svg.append("g").style("display","none");gHiddenCircle=svg.append("g").style("display","none");gTabs=svg.append("g");gSubtabs=svg.append("g");gTooltip=svg.append("g");gHiddenCircleCircle=gHiddenCircle.append("g");gHiddenCircleArcs=gHiddenCircle.append("g");gHiddenCircleContentDonut=gHiddenCircle.append("g").style("display","none");gHiddenCircleContentPie=gHiddenCircle.append("g").style("display","none");gHiddenCircleContentCountry=gHiddenCircle.append("g").style("display","none")}function dataviz(categories,subcategories,foods,samples,type){var maxValue=0;_.each(foods,function(food,nfood){maxValue=Math.max(maxValue,food.value)});CLICKED_RADIUS=type==="food"?90:110;SUBCATEGORIES_TO_SHOW=type==="food"?6:1;initSVG();positionCircles(false);_.each(categories,function(item,index){colors[item]=colors[index]});var color=function(i){return colors[i]};var minRadius=10;var maxRadius=50;var minArea=1e3;var maxArea=3e4;var clusters=new Array(SUBCATEGORIES_TO_SHOW);var nodes=[];var backup=[];var nodesLength=0;_.each(foods,function(food,nfood){var max=type==="food"?maxValue:maxValue;var r;if(type==="food"){r=minRadius+(maxRadius-minRadius)/max*food.value}else{var area=minArea+maxArea/max*food.value;r=Math.sqrt(area/Math.PI)}var i=categories.indexOf(food.category);var x=0;var y=0;if(savedNodes){x=savedNodes[nfood].x;y=savedNodes[nfood].y}var d={cluster:i,radius:r,inhabitants:+food.inhabitants,samples:+food.value,value:+food.value,value_below_loq:food.value_below_loq,value_below_mrl:food.value_below_mrl,value_above_mrl:food.value_above_mrl,countrycode:food.countrycode,food:food.name,subcategory:food.subcategory,category:food.category,color:type==="food"?colors[i]:GRAY,x:x,y:y};nodes.push(d);nodesLength++;if(!clusters[i]||r>clusters[i].radius)clusters[i]=d});expanded=false;expandedName=null;expandedType=null;leftShifted=false;tabOpen=null;function delightCirclesExceptCategory(category){q.d3stopPropagation();if(shifting||expanded){return}if(mobile){d3.selectAll(".efsa-pesticide-subtab").transition().duration(TIME/5).attr("fill",function(d,i){if(i===expandedName){return d3.select(this).attr("fill-default")}return d3.select(this).attr("fill-brighter")})}readyToUser=false;gCircles.attr("opacity","1");if(speedClass<2&&!mobile){circle.style("cursor",function(d){return d.category===category?"pointer":"default"}).transition().duration(TIME).attr("opacity",function(d){return d.category===category?1:SEMITRANSPARENT});setTimeout(function(){readyToUser=true},TIME)}else{circle.attr("opacity",function(d){return d.category===category?1:SEMITRANSPARENT}).style("cursor",function(d){return d.category===category?"pointer":"default"});readyToUser=true}}function delightSubtab(subcategory){if(expandedName!==subcategory){d3.select(this).transition().duration(TIME/5).attr("fill",d3.select(this).attr("fill-brighter"))}}function delightCirclesExceptSubcategory(subcategory){q.d3stopPropagation();if(shifting){return}if(this){if(this!==window){if(mobile){d3.selectAll(".efsa-pesticide-subtab").transition().duration(TIME/5).attr("fill",function(d,i){if(i===expandedName){return d3.select(this).attr("fill-default")}return d3.select(this).attr("fill-brighter")})}d3.select(this).transition().duration(TIME/5).attr("fill",d3.select(this).attr("fill-default"))}}if(expanded){return}readyToUser=false;gCircles.attr("opacity","1");if(speedClass<2&&!mobile){circle.style("cursor",function(d){return d.subcategory===subcategory?"pointer":"default"}).transition().duration(TIME/3).attr("opacity",function(d){return d.subcategory===subcategory?1:SEMITRANSPARENT});setTimeout(function(){readyToUser=true},TIME)}else{circle.attr("opacity",function(d){return d.subcategory===subcategory?1:SEMITRANSPARENT}).style("cursor",function(d){return d.subcategory===subcategory?"pointer":"default"});readyToUser=true}}function removeDelightCircles(){circle.attr("opacity","1");gCircles.attr("opacity","1")}function show(item){item.style("display","block")}function hide(item){item.style("display","none")}function unshowCircleContent(d,i,rhc){q.d3stopPropagation();lastHovered=null;if(!backup||backup.length===0||shown===-1){return}unshowing=true;shown=-1;var foods=circle;foods.attr("stroke-width",0).attr("fill",function(dd,j){return d3.select(this).attr("fill-val")});if(type==="country"){foods.attr("stroke-width",COUNTRIES_BUBBLE_STROKE_WIDTH).attr("stroke",COUNTRIES_BUBBLE_STROKE)}var toFood=0;foods.transition().duration(TIME*.7).ease(q.qeaseElastic).attr("cx",function(dd,j){toFood++;return backup[j].x}).attr("cy",function(dd,j){return backup[j].y}).attr("r",function(dd,j){return d3.select(this).attr("r-val")}).on("end",function(){toFood--;if(!toFood){for(var n=0;n<nodesLength;n++){var bk=backup[n];nodes[n].radius=bk.radius;nodes[n].fx=bk.x;nodes[n].fy=bk.y;nodes[n].x=nodes[n].fx;nodes[n].y=nodes[n].fy}unshowing=false}});lastHovered=null;removeHiddenCircleTexts();if(rhc){removeHiddenCircle(false)}}function showCircleContent(d,i){q.d3stopPropagation();if(!backup||backup.length===0){return}if(!readyToUser||shifting||leftShifted){return}if(expanded){outsideClick()}if(tabOpen!==null&&tabOpen!==d.cluster){return}var o=d3.select("#efsa-pesticide-food-"+i).attr("opacity");if(o!=="1"){return}lastHovered=d.index;if(unshowing){setTimeout(function(){_showCircleContent(d,i)},TIME*.7)}else{_showCircleContent(d,i)}}function _showCircleContent(d,i){if(d.index!==lastHovered){return}if(type!=="food"){hide(gHiddenCircleContentDonut);hide(gHiddenCircleArcs);hide(gHiddenCircleContentPie)}shown=d.index;for(var n=0;n<nodesLength;n++){if(n!==i){nodes[n].fx=null;nodes[n].fy=null}else{nodes[n].fx=backup[i].x;nodes[n].fy=backup[i].y}}nodes[i].radius=CLICKED_RADIUS;force.nodes(nodes).alphaTarget(mobile?.003:.002).alphaDecay(.8).restart();var item=d3.select("#efsa-pesticide-food-"+i);var color=d.color;item.attr("stroke-width",CLICKED_RADIUS/10).attr("stroke",color).attr("fill","white");item.transition().ease(q.qeaseElastic).duration(TIME).attr("r",CLICKED_RADIUS-CLICKED_RADIUS/10);removeExpandedCircleContent(false);showHiddenCircleGroup();var name=d.food;var samples=d.samples;q.d3attr(hiddenCircle,{subcategory:d.subcategory,category:d.category,value_below_loq:d.value_below_loq,value_below_mrl:d.value_below_mrl,value_above_mrl:d.value_above_mrl,samples:samples,name:name});var transform={x:+backup[i].x,y:+backup[i].y};setupHiddenCircle(transform.x,transform.y,color,0);var delay=type==="food"?TIME/2:0;setTimeout(function(){if(d.index===lastHovered){setupHiddenText(transform.x,transform.y,color,name);setupHiddenValue(transform.x,transform.y,color,samples,dictionary.global.samples)}},delay)}function showHiddenCircleGroup(){show(gHiddenCircle);show(hiddenCircle)}function setupHiddenValue(x,y,fill,text,legendText){if(type==="food"){counterAnimation(hiddenValue,lastHiddenValue,text,"",0,4,function(){if(shown===-1){hiddenValue.text("")}});lastHiddenValue=+text;hiddenValueLegend.text(legendText);y+=FONT_BIG;q.d3attr(hiddenValue,{fill:fill,x:x,y:y});q.d3attr(hiddenValueLegend,{fill:fill,x:x,y:y+FONT_BIG})}else{hiddenValue.empty();q.d3attr(hiddenValue,{fill:fill,x:x,y:y})}var w=leftShifted?-width/5:0;var y=0;if(hiddenTextLines===1){y=-FONT_NORMAL}else if(hiddenTextLines===2){y=-FONT_NORMAL/2}q.d3attr(hiddenValue,{transform:"translate("+w+","+y+")"});q.d3attr(hiddenValueLegend,{transform:"translate("+w+","+y+")"})}var hiddenTextLines=0;function setupHiddenText(x,y,fill,text){q.d3attr(hiddenText,{fill:fill,dx:0,dy:"1.1em",x:x,y:y});if(type==="food"){q.d3attr(hiddenButton,{fill:fill,x:x-47,y:y});q.d3attr(hiddenButtonText,{x:x,y:y+14});hiddenButton.style("display","block");hiddenButtonText.style("display","block")}if(type==="food"){hiddenText.text(dictionary.foods[text].toUpperCase())}else{hiddenText.text(dictionary.countries[text].toUpperCase())}if(type==="food"){hiddenText.style("font-size",FONT_NORMAL+"px")}else{hiddenText.style("font-size",FONT_BIG+"px")}var lines=wrap(hiddenText,(CLICKED_RADIUS-CLICKED_RADIUS/4)*2);hiddenTextLines=lines;var h=-hiddenText._groups[0][0].getBBox().height;if(type==="country"){h/=2}else{if(lines>2){h-=FONT_NORMAL/2}else if(lines>1){h-=FONT_NORMAL}else{h-=FONT_NORMAL*2}}var w=leftShifted?-width/5:0;q.d3attr(hiddenText,{transform:"translate("+w+","+h+")"});if(type==="food"){q.d3attr(hiddenButton,{transform:"translate("+w+","+(CLICKED_RADIUS-CLICKED_RADIUS/1.8)+")"});q.d3attr(hiddenButtonText,{transform:"translate("+w+","+(CLICKED_RADIUS-CLICKED_RADIUS/1.8)+")"})}return h}function setupHiddenCircle(cx,cy,stroke,r){show(hiddenCircle);q.d3attr(hiddenCircle,{stroke:stroke,"stroke-width":0,fill:"white",cx:cx,cy:cy,r:r});var w=leftShifted?-width/5:0;q.d3attr(hiddenCircle,{transform:"translate("+w+",0)"})}function wrap(text,width){var lines=1;text.each(function(){var text=d3.select(this),words=text.text().split(/\s+/).reverse(),word,line=[],lineNumber=0,lineHeight=1,x=text.attr("x"),y=text.attr("y"),dy=parseFloat(text.attr("dy")),tspan=text.text(null).append("tspan").attr("x",x).attr("y",y).attr("dy",dy+"em");var word=words.pop();while(word){line.push(word);tspan.text(line.join(" "));if(tspan.node().getComputedTextLength()>width){line.pop();tspan.text(line.join(" "));line=[word];tspan=text.append("tspan").attr("x",x).attr("y",y).attr("dy",++lineNumber*lineHeight+dy+"em").text(word);lines++}word=words.pop()}});return lines}function tabs(categories){if(type!=="food"){return}gTabs.selectAll(".efsa-pesticide-tab-title").data(categories).enter().append("rect").attr("class","efsa-pesticide-tab-title");gTabs.selectAll(".efsa-pesticide-tab-title-text").data(categories).enter().append("text").style("font-size",(FONT_BIG+FONT_NORMAL)/2+"px").attr("class","efsa-pesticide-tab-title-text").attr("x",-300).attr("y",function(d,i){return RIGHT_TABS_Y+i*(tabHeight+tabSpace)+tabHeight/2+6}).text(function(d){return dictionary.foods[d]}).transition().duration(2*TIME).ease(q.qeaseElastic).delay(function(d,i){return TIME+(i+1)*TIME/2}).attr("x",10);maxTabWidth=0;gTabs.selectAll(".efsa-pesticide-tab-title-text").each(function(d,i){maxTabWidth=q.max(maxTabWidth,d3.select(this).node().getBBox().width)});subtabWidth=Math.max(maxTabWidth+30,subtabWidth);gTabs.selectAll(".efsa-pesticide-tab-title").attr("x",0).attr("y",function(d,i){return RIGHT_TABS_Y+i*(tabHeight+tabSpace)}).attr("width",subtabWidth).attr("height",tabHeight).attr("opacity","1").attr("fill",function(d,i){return color(d)}).attr("fill-default",function(d,i){return color(d)}).attr("transform","translate("+-subtabWidth+",0)").transition().duration(2*TIME).delay(function(d,i){return(i+1)*TIME/2}).attr("transform","translate("+-(subtabWidth-(maxTabWidth+30))+",0)");gTabs.append("rect").attr("class","efsa-pesticide-tab-title").attr("x",0).attr("y",function(d,i){return RIGHT_TABS_Y+-1*(tabHeight+tabSpace)}).attr("width",subtabWidth).attr("height",tabHeight).attr("opacity","1").attr("fill",config.all_foods).attr("fill-default",config.all_foods).attr("transform","translate("+-subtabWidth+",0)").transition().duration(2*TIME).delay(function(d,i){return i*TIME/2}).attr("transform","translate("+-(subtabWidth-(maxTabWidth+30))+",0)");gTabs.append("text").style("font-size",(FONT_BIG+FONT_NORMAL)/2+"px").attr("class","efsa-pesticide-tab-title-text").attr("x",-300).attr("y",function(d,i){return RIGHT_TABS_Y+-1*(tabHeight+tabSpace)+tabHeight/2+6}).text(dictionary.global.all_products).transition().duration(2*TIME).ease(q.qeaseElastic).delay(function(d,i){return TIME/2+TIME/2}).attr("x",10)}function openSubtabs(tab){d3.select("#efsa-pesticide-subtabs-group-"+tab).transition().duration(TIME/3).attr("transform","translate(0, 0)")}function subtabs(tab){var tabColor=color(tab);var subtabColor=d3.color(tabColor).brighter(.25);var items=[categories[tab]].concat(subcategories[categories[tab]]);var items=subcategories[categories[tab]];if(items.length<2){return}var g=gSubtabs.append("g");g.attr("id","efsa-pesticide-subtabs-group-"+tab).attr("transform","translate("+-subtabWidth+", 0)");g.selectAll(".efsa-pesticide-subtab-space-"+tab).data(items).enter().append("rect").attr("class","efsa-pesticide-subtab efsa-pesticide-subtab-space-"+tab).attr("x",-1).attr("y",function(d,i){return RIGHT_TABS_Y+(i+2)*(tabHeight+tabSpace)+tab*(tabHeight+tabSpace)-tabSpace-5}).attr("width",subtabWidth).attr("height",tabSpace+5).attr("fill-default","#f4f4f4").attr("fill-brighter","#f4f4f4").attr("fill","#f4f4f4");g.selectAll(".efsa-pesticide-subtab-"+tab).data(items).enter().append("rect").attr("class","efsa-pesticide-subtab efsa-pesticide-subtab-rect efsa-pesticide-subtab-"+tab).attr("x",0).attr("y",function(d,i){return RIGHT_TABS_Y+(i+1)*(tabHeight+tabSpace)+tab*(tabHeight+tabSpace)}).attr("width",subtabWidth).attr("height",tabHeight).attr("fill-default",tabColor).attr("fill-brighter",subtabColor).attr("fill",subtabColor);g.selectAll(".efsa-pesticide-subtab-text-"+tab).data(items).enter().append("text").style("font-size",(FONT_BIG+FONT_NORMAL)/2+"px").attr("class","efsa-pesticide-subtab-text efsa-pesticide-subtab-text-"+tab).attr("x",10).attr("y",function(d,i){return RIGHT_TABS_Y+(i+1)*(tabHeight+tabSpace)+tab*(tabHeight+tabSpace)+tabHeight/2+5}).text(function(d,i){return dictionary.foods[d]})}function toggleSubtab(el){if(shifting){return}q.d3stopPropagation();var cluster=categories.indexOf(el);if(tabOpen===null){removeHiddenCircleTexts();removeHiddenCircle(false);removeExpandedCircleContent(false);openTab(cluster);shiftCircles(function(){delightCirclesExceptCategory(el)})}else if(tabOpen===cluster){return;closeTab();removeDelightCircles();removeHiddenCircleTexts();removeHiddenCircle(false);removeExpandedCircleContent(false);positionCircles(true);expanded=false;expandedName=null;expandedType=null}else{closeTab();return;removeDelightCircles();expanded=false;expandedName=null;expandedType=null;setTimeout(function(){removeHiddenCircleTexts();removeHiddenCircle(false);removeExpandedCircleContent(false);openTab(cluster);shiftCircles(function(){delightCirclesExceptCategory(el)})},TIME)}}function closeTab(){if(tabOpen===null){return}d3.selectAll(".efsa-pesticide-tab-title").transition().duration(TIME/2).attr("transform","translate("+-(subtabWidth-(maxTabWidth+30))+",0)");d3.select("#efsa-pesticide-subtabs-group-"+tabOpen).transition().duration(TIME/3).attr("transform","translate("+-subtabWidth+", 0)");hide(d3.selectAll(".efsa-pesticide-tab-text"));tabOpen=null}function removeHiddenCircle(collapsing){hiddenCircle.attr("pointer-events","none");if(collapsing){hiddenCircle.transition().duration(TIME).attr("stroke-width",0).attr("r",10).on("end",function(){hide(hiddenCircle)})}else{hide(hiddenCircle)}}function removeHiddenCircleTexts(){hiddenText.text("");hiddenValue.text("");hiddenValueLegend.text("");if(type==="food"){hiddenButton.style("display","none");hiddenButtonText.style("display","none")}}function openTab(cluster){tabOpen=cluster;openSubtabs(cluster);readyToUser=false;setTimeout(function(){d3.select(d3.selectAll(".efsa-pesticide-tab-title")._groups[0][cluster]).transition().duration(TIME).attr("transform","translate(0, 0)").on("end",function(){setTimeout(function(){readyToUser=true},TIME*2)})},10)}function init(){prestart();setTimeout(function(){tabs(categories);_.each(categories,function(item,index){subtabs(index)});createTooltip()},200)}function createTooltip(){gTooltip.append("path").attr("id","efsa-pesticide-tooltip").attr("width",0);gTooltip.append("text").attr("id","efsa-pesticide-tooltip-text")}function getTooltipD(x,y,w,h,span){return"M"+x+" "+y+" L"+x+" "+(y-h-span)+" L"+(x-w)+" "+(y-h-span)+" L"+(x-w)+" "+(y-span)+"L "+(x-span/2)+" "+(y-span)+" Z"}var tooltipShown=-1;function moveTooltip(x,y,text,color,id){tooltipShown=id;gTooltip.style("display","block");d3.select("#efsa-pesticide-tooltip-text").text(text);var textWidth=Math.ceil(d3.select("#efsa-pesticide-tooltip-text").node().getBBox().width);d3.select("#efsa-pesticide-tooltip-text").text("");var span=14;var h=26;var w=50+textWidth;d3.select("#efsa-pesticide-tooltip").attr("d",getTooltipD(x,y,w,h,span)).attr("width",w).style("stroke",color);d3.select("#efsa-pesticide-tooltip-text").attr("x",x-w/2).attr("y",y-span-h/3).text(text)}function hideTooltip(id){setTimeout(function(){if(tooltipShown===id||id===-999){gTooltip.style("display","none")}},100)}init();var force;if(FORCE_REFRESH){collide();gCircles.attr("opacity","1");setTimeout(start,15e3)}else{d3.text("/sites/default/files/interactive_tools/pesticides_2017/"+type+"-nodes.dat",function(error,text){if(error)throw error;var parsed=JSON.parse(text);savedNodes=parsed["data"];collide()})}function collapseCircleLabels(callback){d3.selectAll(".efsa-pesticide-expanded-circle-rect-text").attr("x","0");d3.selectAll(".efsa-pesticide-expanded-circle-rect-text").text("");d3.selectAll(".efsa-pesticide-expanded-circle-rect-text-for-country").text("");var callbackCalled=false;d3.selectAll(".efsa-pesticide-expanded-circle-rect").transition().duration(TIME).attr("width",0).attr("transform",function(d,i){var x=d3.select(this).attr("x");var currentYTranslate=0;if(d3.select(this).attr("transform")){currentYTranslate=q.cssTransformTranslateValues(d3.select(this).attr("transform")).y}if(x<0){return"translate("+-x+","+currentYTranslate+")"}return"translate(0,"+currentYTranslate+")"}).on("end",function(){if(callbackCalled){return}callbackCalled=true;callback()})}function expandCircleLabelsForSummary(name,samples,inhabitants){d3.selectAll(".efsa-pesticide-expanded-circle-text-for-country").text(function(d,i){if(i===0){return dictionary.countries[name].toUpperCase()}else if(i===1){return q.numberWithCommas(samples,ths)}else if(i===2){return dictionary.global.samples.toUpperCase()}else if(i===3){var value=samples/(inhabitants/1e5);var vtext=value.toFixed(1);vtext=vtext.replace(",","x");vtext=vtext.replace(".","x");var decimalPart=vtext.split("x")[1];vtext=q.numberWithCommas(q.floor(value),ths);vtext=vtext.replace(",",ths);vtext=vtext.replace(".",ths);vtext+=ds+decimalPart;return vtext}else if(i===4){return dictionary.global.samples_100000.toUpperCase()}else if(i===5){return dictionary.global.inhabitants.toUpperCase()}return""});counterAnimation(d3.select(d3.selectAll(".efsa-pesticide-expanded-circle-text-for-country")._groups[0][1]),0,samples,"",0,4);counterAnimation(d3.select(d3.selectAll(".efsa-pesticide-expanded-circle-text-for-country")._groups[0][3]),0,samples/(inhabitants/1e5),"",1,4);var textWidths=[];d3.selectAll(".efsa-pesticide-expanded-circle-rect-text").attr("transform","translate(0,0)").style("display",function(d,i){return i>0&&i<3?"block":"none"}).style("font-weight","300").text(function(dz,i){if(i===0){if(type==="food"){return name.toUpperCase()}else if(type==="country"){return dictionary.countries[name].toUpperCase()}}if(i===1)return dictionary.global.overall_results;if(i===2)return dictionary.global.origin_of_samples;if(i===3)return""}).attr("x",0).transition().duration(TIME).delay(function(dz,i){return TIME+i*TIME/4}).attr("x",function(dz,i){d3.selectAll(".efsa-pesticide-expanded-circle-rect-text").style("display","block");var w=+d3.selectAll(".efsa-pesticide-expanded-circle-rect-text")._groups[0][i].getBBox().width+EXPANDED_RADIUS+EXPANDED_RADIUS/9*i;if(type==="country"&&i===0){w-=EXPANDED_RADIUS/9}textWidths.push(w);if(i===0){return-w}return EXPANDED_RADIUS+EXPANDED_RADIUS/9*i});d3.selectAll(".efsa-pesticide-expanded-circle-rect").attr("transform","translate(0,0)").style("display",function(d,i){return i>=0&&i<3?"block":"none"}).style("cursor",function(d,i){return i>0&&i<3?"pointer":"default"}).attr("x",function(dz,i){return 0}).transition().duration(TIME).delay(function(dz,i){return i*TIME/4}).attr("x",function(dz,i){if(i===0){return-textWidths[i]-10}return 0}).attr("width",function(dz,i){return+textWidths[i]+10}).on("end",function(dz,i){if(type==="country"&&i===0){gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-all").remove();gHiddenCircle.append("rect").attr("id","efsa-pesticide-expanded-circle-rect-close-all").attr("x",-d3.select("#efsa-pesticide-expanded-circle-rect-0").attr("width")-tabHeight-2).attr("y",-EXPANDED_RADIUS+EXPANDED_RADIUS/10).attr("width",tabHeight).attr("height",tabHeight).attr("fill","#a8a8a8").attr("cursor","pointer").on("click",function(){outsideClick()}).on("mouseover",function(){d3.select("#efsa-pesticide-expanded-circle-rect-close-all-text").style("text-decoration","underline")}).on("mouseout",function(){d3.select("#efsa-pesticide-expanded-circle-rect-close-all-text").style("text-decoration","none")});gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-all-text").remove();gHiddenCircle.append("text").attr("id","efsa-pesticide-expanded-circle-rect-close-all-text").attr("x",-d3.select("#efsa-pesticide-expanded-circle-rect-0").attr("width")-tabHeight-2+tabHeight/2).attr("y",-EXPANDED_RADIUS+EXPANDED_RADIUS/10+tabHeight/2+FONT_NORMAL/2.5).attr("text-anchor","middle").attr("fill","white").style("font-size",FONT_BIG*1.25+"px").text("x")}});setTimeout(function(){d3.select("#efsa-pesticide-expanded-circle-rect-icon-pie-chart").attr("transform","translate(0,0)").style("display","block");d3.select("#efsa-pesticide-expanded-circle-rect-icon-map-marker").attr("transform","translate(0,0)").style("display","block")},TIME*2)}function expandCircleLabelsForDonut(name,samples,subtab,itemtype){var textWidths=[];var counter=d3.select("#efsa-pesticide-expanded-circle-rect-text-1");var currentValue=counter.text();circle.attr("opacity",SEMITRANSPARENT);d3.selectAll(".efsa-pesticide-expanded-circle-rect-text").style("display","block").attr("text-anchor","end").text(function(dz,i){if(i===0){return name}if(i===1){return q.numberWithCommas(samples,ths)+" "+dictionary.global.samples}if(i===2){if(itemtype===ITEM){return dictionary.global.all_products}else if(itemtype===SUBCATEGORY){return dictionary.global.back_to_subcategory}else if(itemtype===CATEGORY){return dictionary.global.back_to_category}}if(i===3)return""}).transition().duration(TIME).delay(function(dz,i){return i*TIME}).attr("x",function(dz,i){var w=d3.selectAll(".efsa-pesticide-expanded-circle-rect-text")._groups[0][i].getBBox().width+EXPANDED_RADIUS+EXPANDED_RADIUS/9*i;textWidths.push(w);return+textWidths[i]});currentValue=parseInt(currentValue);if(isNaN(currentValue)){currentValue=0}counterAnimation(counter,currentValue,samples," "+dictionary.global.samples,0,4);if(subtab){subtab.attr("fill",subtab.attr("fill-default"));d3.selectAll(".efsa-pesticide-expanded-circle-rect").attr("fill",subtab.attr("fill-default"));hiddenCircle.attr("stroke",subtab.attr("fill-default"))}d3.select("#efsa-pesticide-expanded-circle-rect-3").attr("y",subtab.attr("y")-height/2).attr("x",-(width/2-subtabWidth+2)).attr("fill",subtab.attr("fill-default")).attr("width",0);d3.selectAll(".efsa-pesticide-expanded-circle-rect").attr("transform","translate(0,0)").style("display","block").style("cursor",function(dz,i){if(i===2)return"pointer";return"default"}).transition().duration(TIME).delay(function(dz,i){if(i===3){return 0}return i*TIME}).attr("x",function(dz,i){if(i===3){return-(width/2-subtabWidth+2)}return 0}).attr("width",function(dz,i){if(i===3){return width/2-(subtabWidth+tabWidth/2)+2}return+textWidths[i]+10}).on("end",function(d,i){if(type==="food"&&i===0){gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-food-name").remove();gHiddenCircle.append("rect").attr("id","efsa-pesticide-expanded-circle-rect-close-food-name").attr("x",+d3.select("#efsa-pesticide-expanded-circle-rect-0").attr("width")+2).attr("y",-EXPANDED_RADIUS+EXPANDED_RADIUS/10).attr("width",tabHeight).attr("height",tabHeight).attr("fill",subtab.attr("fill-default")).attr("cursor","pointer").on("click",function(){outsideClick();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-food-name").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-food-name-text").remove()}).on("mouseover",function(){d3.select("#efsa-pesticide-expanded-circle-rect-close-food-name-text").style("text-decoration","underline")}).on("mouseout",function(){d3.select("#efsa-pesticide-expanded-circle-rect-close-food-name-text").style("text-decoration","none")});gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-food-name-text").remove()
;gHiddenCircle.append("text").attr("id","efsa-pesticide-expanded-circle-rect-close-food-name-text").attr("x",+d3.select("#efsa-pesticide-expanded-circle-rect-0").attr("width")+2+tabHeight/2).attr("y",-EXPANDED_RADIUS+EXPANDED_RADIUS/10+2+tabHeight/2+FONT_NORMAL/2.5).attr("text-anchor","middle").attr("fill","white").style("font-size",FONT_BIG*1.25+"px").text("x")}});if(itemtype===ITEM){hide(d3.select("#efsa-pesticide-expanded-circle-rect-2"));hide(d3.select("#efsa-pesticide-expanded-circle-rect-text-2"))}else{show(d3.select("#efsa-pesticide-expanded-circle-rect-2"));show(d3.select("#efsa-pesticide-expanded-circle-rect-text-2"))}setTimeout(function(){if(itemtype===SUBCATEGORY){d3.select("#efsa-pesticide-expanded-circle-rect-icon-sub-category").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/sub-category.png");d3.select("#efsa-pesticide-expanded-circle-rect-icon-sub-category").style("display","block")}else if(itemtype===CATEGORY){d3.select("#efsa-pesticide-expanded-circle-rect-icon-sub-category").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/category.png");d3.select("#efsa-pesticide-expanded-circle-rect-icon-sub-category").style("display","block")}},TIME*2.5)}function counterAnimation(counter,currentValue,endValue,suffix,decimals,iter,callback){if(mobile){iter/=2}var nintv=0;var intv=setInterval(function(){currentValue=q.round((currentValue+endValue)/2);if(currentValue<100){var vtext=currentValue.toFixed(decimals);vtext=vtext.replace(".",ds);vtext=vtext.replace(",",ds);counter.text(vtext+suffix)}else{counter.text(q.numberWithCommas(currentValue.toFixed(decimals),ths)+suffix)}nintv++;if(nintv>iter){clearInterval(intv);if(endValue<100){var vtext=endValue.toFixed(decimals);vtext=vtext.replace(".",ds);vtext=vtext.replace(",",ds);counter.text(vtext+suffix)}else{counter.text(q.numberWithCommas(endValue.toFixed(decimals),ths)+suffix)}if(callback){callback()}}},40)}function expandHiddenCircle(color,category,subcategory,name,samples,value_below_loq,value_below_mrl,value_above_mrl,itemtype){hideTooltip(-1);var needsToExpand=!expanded;expanded=true;hiddenCircle.attr("pointer-events","inherit");circle.style("cursor","default");q.d3stopPropagation();q.d3attr(hiddenCircle,{transform:"translate(0,0)"});hiddenCircle.attr("stroke",color);if(color){d3.selectAll(".efsa-pesticide-expanded-circle-rect").attr("fill",color)}removeHiddenCircleTexts();setTimeout(function(){if(type==="food"){show(gHiddenCircleContentDonut);show(gHiddenCircleArcs)}else if(type==="country"){show(gHiddenCircleContentCountry)}removeHiddenCircleTexts()},TIME);var categoryIndex=categories.indexOf(category);var subcategoryIndex=-1;if(subcategory&&subcategory!==""){subcategoryIndex=subcategories[category].indexOf(subcategory)}expandedName=subcategory||category;expandedType=itemtype;if(type==="food"){openTab(categoryIndex)}d3.selectAll(".efsa-pesticide-subtab-"+categoryIndex).attr("transform","translate(0,0)");d3.selectAll(".efsa-pesticide-subtab-space-"+categoryIndex).attr("transform","translate(0,0)");d3.selectAll(".efsa-pesticide-subtab-text-"+categoryIndex).attr("transform","translate(0,0)");var subtab=null;if(subcategoryIndex>-1&&categoryIndex<4){if(d3.select("#efsa-pesticide-subtabs-group-"+categoryIndex).selectAll(".efsa-pesticide-subtab-rect")._groups.length){subtab=d3.select("#efsa-pesticide-subtabs-group-"+categoryIndex).selectAll(".efsa-pesticide-subtab-rect")._groups[0][subcategoryIndex]}else{subtab=d3.selectAll(".efsa-pesticide-tab-title")._groups[0][subcategoryIndex]}}else{if(d3.selectAll(".efsa-pesticide-tab-title")._groups.length){subtab=d3.selectAll(".efsa-pesticide-tab-title")._groups[0][categoryIndex]}else{subtab=d3.selectAll(".efsa-pesticide-tab-title")._groups[0][categoryIndex]}}if(subtab){if(mobile){d3.selectAll(".efsa-pesticide-subtab").attr("fill",function(d,i){return d3.select(this).attr("fill-brighter")})}else{d3.selectAll(".efsa-pesticide-subtab").transition().duration(TIME/5).attr("fill",function(d,i){return d3.select(this).attr("fill-brighter")})}if(subcategoryIndex>-1){if(mobile){d3.select(subtab).attr("fill",d3.select(subtab).attr("fill-default"))}else{d3.select(subtab).transition().duration(TIME/5).attr("fill",d3.select(subtab).attr("fill-default"))}}}if(type==="food"){setTimeout(function(){if(needsToExpand){d3.selectAll(".efsa-pesticide-expanded-circle-rect-text").attr("x",0)}expandCircleLabelsForDonut(dictionary.foods[name],samples,d3.select(subtab),itemtype)},needsToExpand&&type==="food"?TIME:0)}else if(type==="country"){setTimeout(function(){expandCircleLabelsForSummary(name,samples[0],samples[1])},needsToExpand?TIME:0)}show(gHiddenCircle);show(hiddenCircle);hiddenCircle.attr("cx",0).attr("cy",0);if(type==="food"){donut(value_below_loq,value_below_mrl,value_above_mrl)}else{hiddenCircle.attr("stroke-width",EXPANDED_RADIUS/10).transition().duration(TIME).attr("r",EXPANDED_RADIUS)}}function pie(v1,v2,v3,v4,name){var PIE_BACKGROUND_COLOR="#e8e8e8";d3.selectAll(".efsa-pesticide-expanded-circle-pie").selectAll("*").remove();var mytime=pieShown?0:TIME;pieShown=true;hiddenCircle.attr("stroke-width",EXPANDED_RADIUS/10).transition().duration(mytime).attr("r",EXPANDED_RADIUS).on("end",function(){var color=[PIE_BACKGROUND_COLOR,PIE_BACKGROUND_COLOR,PIE_BACKGROUND_COLOR,PIE_BACKGROUND_COLOR,"#3186d3","#dd6c31","#ac56c1","#33b53c"];var colorDarker=[PIE_BACKGROUND_COLOR,PIE_BACKGROUND_COLOR,PIE_BACKGROUND_COLOR,PIE_BACKGROUND_COLOR,"#1166b3","#bd4c11","#8c36a1","#13951c"];var data=[v1,v2,v3,v4];var sum=v1+v2+v3+v4;var dv1=1/sum*data[0];var dv2=1/sum*data[1];var dv3=1/sum*data[2];var dv4=1/sum*data[3];var val1=" "+(100*dv1).toFixed(1).replace(".",ds).replace(",",ds)+"%";var val2=" "+(100*dv2).toFixed(1).replace(".",ds).replace(",",ds)+"%";var val3=" "+(100*dv3).toFixed(1).replace(".",ds).replace(",",ds)+"%";var val4=" "+(100*dv4).toFixed(1).replace(".",ds).replace(",",ds)+"%";var labels=[dictionary.composition_chart.domestic_samples+val1,dictionary.composition_chart.eea_countries+val2,dictionary.composition_chart.third_countries+val3,dictionary.composition_chart.unknown_origin+val4];var wholeTime=mytime;data=data.sort(function(a,b){if(a>b)return-1;else if(a<b)return+1;else return 0});var outerRadius=EXPANDED_RADIUS-EXPANDED_RADIUS/15;arc(d3.select(".efsa-pesticide-expanded-circle-pie"),0,1,color[0],wholeTime,outerRadius+outerRadius/35-outerRadius/5,outerRadius,function(){});arc(d3.select(".efsa-pesticide-expanded-circle-pie"),0,1,color[1],wholeTime/2,outerRadius+outerRadius/35-outerRadius/5*2,outerRadius-outerRadius/5,function(){});arc(d3.select(".efsa-pesticide-expanded-circle-pie"),0,1,color[2],wholeTime/3,outerRadius+outerRadius/35-outerRadius/5*3,outerRadius-outerRadius/5*2,function(){});arc(d3.select(".efsa-pesticide-expanded-circle-pie"),0,1,color[3],wholeTime/4,outerRadius+outerRadius/35-outerRadius/5*4,outerRadius-outerRadius/5*3,function(){});arc(d3.select(".efsa-pesticide-expanded-circle-pie"),0,dv1,color[4],wholeTime*2,outerRadius+outerRadius/35-outerRadius/5,outerRadius,function(){});arc(d3.select(".efsa-pesticide-expanded-circle-pie"),0,dv2,color[5],wholeTime*1.5,outerRadius+outerRadius/35-outerRadius/5*2,outerRadius-outerRadius/5,function(){});arc(d3.select(".efsa-pesticide-expanded-circle-pie"),0,dv3,color[6],wholeTime,outerRadius+outerRadius/35-outerRadius/5*3,outerRadius-outerRadius/5*2,function(){});arc(d3.select(".efsa-pesticide-expanded-circle-pie"),0,dv4,color[7],wholeTime/1.5,outerRadius+outerRadius/35-outerRadius/5*4,outerRadius-outerRadius/5*3,function(){d3.select(".efsa-pesticide-expanded-circle-pie").selectAll("path").style("cursor","pointer").on("mousemove",function(d,i){if(d3.select(this).attr("fill")!==PIE_BACKGROUND_COLOR){pieArcMouseOver(this,labels,i-4,colorDarker[i])}}).on("mouseout",function(d,i){hideTooltip(-1);pieArcMouseOut(this,color[i])}).on("click",function(d,i){q.d3stopPropagation();if(i>3){hideTooltip(-1);if(i==4){ga("send","event",{eventCategory:"Pesticides origin chart",eventAction:"EEA",eventLabel:"EEA"})}else if(i==5){ga("send","event",{eventCategory:"Pesticides origin chart",eventAction:"Domestic",eventLabel:"Domestic"})}else if(i==6){ga("send","event",{eventCategory:"Pesticides origin chart",eventAction:"Third Countries",eventLabel:"Third Countries"})}else if(i==7){ga("send","event",{eventCategory:"Pesticides origin chart",eventAction:"Unknown origin",eventLabel:"Unknown origin"})}showCompositionChart(name,subcategories,false,true,0,[COUNTRIES_SPECIES_TYPES[i-4]])}})});var pieChartIconSize=mobile?70:80;d3.select(".efsa-pesticide-expanded-circle-pie").append("image").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/pie-chart-icon.png").style("cursor","pointer").attr("x",-pieChartIconSize/2).attr("y",-pieChartIconSize/2).attr("width",pieChartIconSize).attr("height",pieChartIconSize).on("mouseover",function(){d3.select(this).attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/pie-chart-icon-over.png")}).on("mouseout",function(){d3.select(this).attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/pie-chart-icon.png")}).on("click",function(d,i){q.d3stopPropagation();hideTooltip(-1);ga("send","event",{eventCategory:"Pesticides origin chart",eventAction:"All",eventLabel:"All"});showCompositionChart(name,subcategories,false,true,0,null)})})}function pieArcMouseOver(that,labels,i,darkerColor){d3.select(that).attr("opacity",1);d3.select(that).transition().duration(TIME/3).attr("fill",darkerColor);moveTooltip(+d3.event.x+2,+d3.event.y-60,labels[i],darkerColor,-1)}function pieArcMouseOut(that,color){d3.select(that).attr("opacity",1);d3.select(that).transition().duration(TIME/2).attr("fill",color)}function setCompositionChartFilter(i){var actual=d3.select(".efsa-composition-chart-legend-item-"+i+"-text").classed("efsa-pesticide-composition-chart-filter-inactive");d3.select(".efsa-composition-chart-legend-item-"+i+"-text").classed("efsa-pesticide-composition-chart-filter-inactive",!actual)}function showCompositionChart(name,subcategories,reverse,animation,from,initialFiltering){var MYTIME=animation?TIME:0;if(expanded||compositionChartDonutExpanded){closeExpanded()}hide(gCircles);hide(gHiddenCircleContentDonut);hide(gHiddenCircleArcs);var types=COUNTRIES_SPECIES_TYPES;var typesLong=[dictionary.composition_chart.domestic_samples,dictionary.composition_chart.eea_countries,dictionary.composition_chart.third_countries,dictionary.composition_chart.unknown_origin];var filters=[];if(initialFiltering){filters=initialFiltering}else{for(var i=0;i<4;i++){var item=d3.select(".efsa-composition-chart-legend-item-"+i+"-text");if(!item.node()||!item.classed("efsa-pesticide-composition-chart-filter-inactive")){filters.push(types[i])}}}gCompositionChart.empty();gCompositionChart.html("");gCompositionChart.node().innerHTML="";gCompositionChart.selectAll("*").remove();gCompositionChart.style("opacity","1");gCompositionChart.append("rect").attr("x",0).attr("y",0).attr("width",width).attr("height",height).attr("fill","#f4f4f4");gCompositionChart.append("rect").attr("x",width-70).attr("y",0).attr("width",50).attr("height",50).attr("fill","#f4f4f4").on("click",function(){closeCompositionChart()});gCompositionChart.append("text").style("pointer-events","auto").style("cursor","pointer").attr("x",width-45).attr("y",FONT_BIG*4.6).text("x").attr("font-size","36px").on("mouseover",function(){d3.select(this).style("text-decoration","underline")}).on("mouseout",function(){d3.select(this).style("text-decoration","none")}).on("click",function(){closeCompositionChart()});var typeColors={Domestic:{normal:"#0b4e99",brighter:"#61a1db"},EU:{normal:"#dd6c31",brighter:"#e28e61"},TC:{normal:"#ac56c1",brighter:"#be7dcd"},UN:{normal:"#33b53c",brighter:"#63c46a"}};var relatedData;if(reverse){relatedData=[];for(var c in samples.composition){var countryData=samples.composition[c];for(var d in countryData){if(countryData[d].country===name){relatedData.push({country:c,type:countryData[d].type,samples:countryData[d].samples})}}}}else{relatedData=samples.composition[name]}var wholeSum=0;for(var r in relatedData){wholeSum+=relatedData[r].samples}relatedData=relatedData.filter(function(obj){return filters.indexOf(obj.type)>-1});var max=0;var sum=0;for(var r in relatedData){max=Math.max(max,relatedData[r].samples);sum+=relatedData[r].samples}relatedData=relatedData.sort(function(a,b){a=normalizeFirstLetter(dictionary.countries[a.country]);b=normalizeFirstLetter(dictionary.countries[b.country]);if(a<b){return-1}else if(a>b){return+1}else{return 0}});var maxBarWidth=width/3.8,marginLeft=width/100,marginRight=width/100,barHeight=height/35,textWidth=width/10;var NROWS=22;if(width<1111){NROWS=10;barHeight*=1.75}var topSpace=barHeight*6;var wScale=d3.scaleLinear().domain([0,max]).range([0,maxBarWidth]);var rightRectangleX=width-textWidth-maxBarWidth-marginRight;gCompositionChart.append("text").attr("x",width/2).attr("y",FONT_BIG*2).attr("text-anchor","middle").attr("fill","#202020").attr("font-size",FONT_BIG).attr("font-weight","400").text(dictionary.composition_chart.title);var legendItemWidth=width/70;for(var i=0;i<4;i++){(function(i){var addClass=filters.indexOf(types[i])<0?" efsa-pesticide-composition-chart-filter-inactive ":"";var xStart=width/6*(i+1)+legendItemWidth/2;var itemColor=typeColors[types[i]].normal;var xEnd=xStart+legendItemWidth;var yStart=FONT_BIG*3.5;var yEnd=yStart+width/70;if(width<1025){xEnd+=2;yEnd+=2}if(width<800){xStart-=3;yStart-=3}gCompositionChart.append("rect").attr("x",xStart).attr("width",xEnd-xStart).attr("y",yStart).attr("height",yEnd-yStart).attr("fill","transparent").style("cursor","pointer").on("click",function(){setCompositionChartFilter(i);setTimeout(function(){showCompositionChart(name,subcategories,reverse,true,0,null)},50)}).on("mouseover",function(){d3.selectAll(".efsa-composition-chart-legend-item-"+i+"-close").attr("opacity",.5)}).on("mouseout",function(){d3.selectAll(".efsa-composition-chart-legend-item-"+i+"-close").attr("opacity",1)});gCompositionChart.append("text").attr("class","efsa-composition-chart-legend-item efsa-composition-chart-legend-item-"+i+"-text efsa-composition-chart-legend-item-"+i+addClass).attr("x",xStart+legendItemWidth+5).attr("y",FONT_BIG*3.6+legendItemWidth-FONT_NORMAL/2+(mobile?3:0)).attr("font-weight","400").attr("font-size",width<800?"10px":width<1025?"13px":"15px").attr("fill",itemColor).text(typesLong[i]);if(addClass){var xPad=2;xStart+=xPad;xEnd-=xPad;yStart+=xPad;yEnd-=xPad;d="M"+xStart+","+yStart+" L"+xEnd+","+yStart+" L"+xEnd+","+yEnd+" L"+xStart+","+yEnd+" Z"}else{var xPad=2;xStart+=xPad;xEnd-=xPad;yStart+=xPad;yEnd-=xPad;var xCenter=xStart+(xEnd-xStart)/2;var yCenter=yStart+(yEnd-yStart)/2;d="M"+xStart+","+yStart+" L"+xEnd+","+yStart+" L"+xEnd+","+yEnd+" L"+xStart+","+yEnd+" Z M"+(xCenter-3)+","+yCenter+" L"+(xCenter-1)+","+(yCenter+3)+" L"+(xCenter+4)+","+(yCenter-3)+""}gCompositionChart.append("path").attr("class","efsa-composition-chart-legend-item efsa-composition-chart-legend-item-"+i+"-close efsa-composition-chart-legend-item-"+i).attr("d",d).attr("stroke",itemColor).attr("fill","transparent").attr("stroke-width","2px").style("pointer-events","none")})(i)}var grayBarY=topSpace-barHeight*2;gCompositionChart.append("rect").attr("x",marginLeft).attr("y",grayBarY).attr("width",width/2-marginLeft-1).attr("height",barHeight*1.5).attr("fill","#dbdbdb");gCompositionChart.append("rect").attr("x",width/2+1).attr("y",grayBarY).attr("width",width/2-marginRight-1).attr("height",barHeight*1.5).attr("fill","#dbdbdb");gCompositionChart.append("text").attr("x",marginLeft+15).attr("y",grayBarY+FONT_BIG*1.5).attr("fill","#202020").style("font-size",FONT_BIG+"px").attr("font-weight","400").text(dictionary.composition_chart.origin);gCompositionChart.append("text").attr("x",width-marginRight-15).attr("y",grayBarY+FONT_BIG*1.5).attr("fill","#202020").text(dictionary.composition_chart.analysing_countries).style("font-size",FONT_BIG+"px").attr("font-weight","400").attr("text-anchor","end");show(gCompositionChart);var to=relatedData.length<from+NROWS?relatedData.length:from+NROWS;var backgroundRectW=textWidth+maxBarWidth;for(var i=from;i<to;i++){var backgroundRectX=reverse?width-backgroundRectW-marginRight:marginLeft;var rectX=reverse?backgroundRectX:marginLeft+textWidth+maxBarWidth-wScale(relatedData[i].samples);var rectW=wScale(relatedData[i].samples);var rectY=(i-from)*(barHeight+5)+topSpace;var rectH=barHeight;var textX=reverse?width-marginRight-5:backgroundRectX+5;var textAnchor=reverse?"end":"start";(function(i,name){gCompositionChart.append("rect").attr("x",backgroundRectX).attr("width",backgroundRectW).attr("y",rectY).attr("height",barHeight).attr("fill","#ffffff").style("cursor","pointer").on("click",function(d,j){q.d3stopPropagation();showCompositionChart(name,subcategories,reverse?false:true,true,0,null)}).on("mouseover",function(d,j){compositionChartItemMouseOver(this,"#composition-chart-text-origin-"+i)}).on("mouseout",function(d,j){compositionChartItemMouseOut(this,"#composition-chart-text-origin-"+i,"#ffffff","#202020")})})(i,relatedData[i].country);var tcountry=dictionary.countries[relatedData[i].country];tcountry=tcountry?tcountry:relatedData[i].country;gCompositionChart.append("text").attr("id","composition-chart-text-origin-"+i).attr("x",textX).attr("y",rectY+FONT_NORMAL*1.5).attr("text-anchor",textAnchor).attr("fill","#202020").attr("font-size",FONT_NORMAL+"px").text(relatedData[i].country===name?dictionary.global.domestic+" ("+q.numberWithCommas(relatedData[i].samples,ths)+")":(tcountry.length>50?tcountry.substr(0,48)+"..":tcountry)+" ("+q.numberWithCommas(relatedData[i].samples,ths)+")");gCompositionChart.append("rect").attr("x",rectX).attr("width",rectW).attr("y",rectY).attr("height",rectH).style("pointer-events","none").attr("fill",typeColors[relatedData[i].type].normal).attr("opacity",0).transition().delay(animation?i*20:0).duration(MYTIME).attr("opacity",1);var d=reverse?"M"+backgroundRectX+","+rectY+" L"+(textWidth+maxBarWidth+marginLeft)+","+(rectH/2+topSpace)+" L"+backgroundRectX+","+(rectY+rectH)+" Z":"M"+(rectX+rectW)+","+rectY+" L"+rightRectangleX+","+(rectH/2+topSpace)+" L"+(rectX+rectW)+","+(rectY+rectH)+" Z";gCompositionChart.append("path").attr("d",d).attr("fill",typeColors[relatedData[i].type].brighter).attr("opacity",0).transition().delay(animation?i*20:0).duration(MYTIME).attr("opacity",1)}if(from<relatedData.length-NROWS+1){gCompositionChart.append("image").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/menu arrow down b.png").attr("x",reverse?width-backgroundRectW/1.5-25:backgroundRectW/1.5-25).attr("y",height-barHeight*1.5).attr("height",barHeight/1.3).attr("width",barHeight/1.3).style("cursor","pointer").on("click",function(){q.d3stopPropagation();showCompositionChart(name,subcategories,reverse,false,from+1,null)})}if(from>0){gCompositionChart.append("image").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/menu arrow up b.png").attr("x",reverse?width-backgroundRectW/1.5+25:backgroundRectW/1.5+25).attr("y",height-barHeight*1.5).attr("height",barHeight/1.3).attr("width",barHeight/1.3).style("cursor","pointer").on("click",function(){q.d3stopPropagation();showCompositionChart(name,subcategories,reverse,false,from-1,null)})}gCompositionChart.on("mousewheel",null);gCompositionChart.on("wheel",null);var lenm=relatedData.length-NROWS+1;var event=isSaf?"mousewheel":"wheel";(function(name,subcategories,reverse,from,lenm){gCompositionChart.on(event,function(d,i){var delta=d3.event.wheelDelta||d3.event.deltaY;if(isFF||isIE){delta=-delta}if(delta<0&&from<lenm){showCompositionChart(name,subcategories,reverse,false,from+1,null)}if(delta>0&&from>0){showCompositionChart(name,subcategories,reverse,false,from-1,null)}})})(name,subcategories,reverse,from,lenm);gCompositionChart.append("rect").attr("x",reverse?marginRight:rightRectangleX).attr("width",textWidth+maxBarWidth).attr("y",0+topSpace).attr("height",barHeight).attr("fill","#0b4e99");gCompositionChart.append("text").attr("x",reverse?marginRight+5:rightRectangleX+5).attr("y",0+FONT_NORMAL*1.3+topSpace).attr("fill","#ffffff").style("font-size",FONT_NORMAL+"px").text(dictionary.countries[name]?dictionary.countries[name]+" ("+q.numberWithCommas(sum,ths)+")":name+" ("+q.numberWithCommas(sum,ths)+")");gCompositionChart.append("image").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/menu arrow down.png").attr("x",reverse?textWidth+maxBarWidth-barHeight/2-10:rightRectangleX+textWidth+maxBarWidth-barHeight/2-10).attr("y",0+topSpace+barHeight/2-barHeight/4).attr("height",barHeight/2).attr("width",barHeight/2).style("cursor","pointer").on("click",function(){q.d3stopPropagation();show(d3.selectAll(".composition-chart-dropdown-analysing"))});gCompositionChart.append("image").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/pie chart.png").attr("x",reverse?textWidth+maxBarWidth-3*barHeight/2-10:rightRectangleX+textWidth+maxBarWidth-3*barHeight/2-10).attr("y",0+topSpace+barHeight/2-barHeight/4).attr("height",barHeight/2).attr("width",barHeight/2).style("cursor","pointer").on("click",function(){q.d3stopPropagation();var v1=reverse?sideData2[name].value_below_loq:sideData1[name].value_below_loq;var v2=reverse?sideData2[name].value_below_mrl:sideData1[name].value_below_mrl;var v3=reverse?sideData2[name].value_above_mrl:sideData1[name].value_above_mrl;showCompositionChartDonut(name,v1,v2,v3,sum,reverse,wholeSum)});var orderedCountries;if(reverse){orderedCountries=[];for(var nation in sideData2){orderedCountries.push(nation)}orderedCountries=orderedCountries.sort(function(a,b){a=normalizeFirstLetter(dictionary.countries[a]);b=normalizeFirstLetter(dictionary.countries[b]);if(a>b){return 1}else if(a<b){return-1}else{return 0}})}else{orderedCountries=subcategories.countries.sort(function(a,b){a=normalizeFirstLetter(dictionary.countries[a]);b=normalizeFirstLetter(dictionary.countries[b]);if(a>b){return 1}else if(a<b){return-1}else{return 0}})}var dropdownFrom=0;var dropdownTo=height>800?32:20;writeCountriesDropdown(dropdownFrom,dropdownTo,orderedCountries,reverse,marginLeft,rightRectangleX,topSpace,barHeight,textWidth,maxBarWidth,false);gCompositionChart.append("rect").attr("id","composition-chart-cover").attr("x",0).attr("y",topSpace-5).attr("width",width).attr("height",height-topSpace).attr("fill","#ffffff").attr("opacity",.85).style("display","none")}function writeCountriesDropdown(from,to,orderedCountries,reverse,marginLeft,rightRectangleX,topSpace,barHeight,textWidth,maxBarWidth,byScroll){gCompositionChart.selectAll(".composition-chart-dropdown-analysing").remove();var SCROLL_STEPS=7;var dropdownBarHeight=FONT_NORMAL*1.4;var event=isSaf?"mousewheel":"wheel";var lastY=0;for(var i=from,x=orderedCountries.length;i<to&&i<x;i++){(function(i,country,reverse){var y=0+topSpace+(i-from+1)*dropdownBarHeight+barHeight-FONT_NORMAL;lastY=y;gCompositionChart.append("rect").attr("class","composition-chart-dropdown-analysing").style("display",byScroll?"block":"none").attr("x",reverse?marginLeft:rightRectangleX).attr("y",y).attr("width",textWidth+maxBarWidth).attr("height",dropdownBarHeight).attr("fill","#eaeaea").style("cursor","pointer").on("click",function(d,j){q.d3stopPropagation();showCompositionChart(country,subcategories,reverse?true:false,true,0,null)}).on("mouseover",function(d,j){compositionChartItemMouseOver(this,"#composition-chart-text-analysing-"+i)}).on("mouseout",function(d,j){compositionChartItemMouseOut(this,"#composition-chart-text-analysing-"+i,"#eaeaea","#202020")}).on(event,function(d,j){q.d3stopPropagation();var delta=d3.event.wheelDelta||d3.event.deltaY;if(isFF||isIE){delta=-delta}if(delta<0){if(to<x){from+=SCROLL_STEPS;to+=SCROLL_STEPS}writeCountriesDropdown(from,to,orderedCountries,reverse,marginLeft,rightRectangleX,topSpace,barHeight,textWidth,maxBarWidth,true)}else{if(from>SCROLL_STEPS-1){from-=SCROLL_STEPS;to-=SCROLL_STEPS}writeCountriesDropdown(from,to,orderedCountries,reverse,marginLeft,rightRectangleX,topSpace,barHeight,textWidth,maxBarWidth,true)}});var tcountry=dictionary.countries[country];tcountry=tcountry?tcountry:country;gCompositionChart.append("text").attr("class","composition-chart-dropdown-analysing").style("display",byScroll?"block":"none").attr("id","composition-chart-text-analysing-"+i).attr("x",reverse?marginLeft+5:rightRectangleX+5).attr("y",y+FONT_NORMAL).attr("fill","#202020").attr("font-size",FONT_NORMAL+"px").style("cursor","pointer").text(tcountry)})(i,orderedCountries[i],reverse)}if(from<orderedCountries.length-(to-from)){gCompositionChart.append("image").attr("class","composition-chart-dropdown-analysing").style("display",byScroll?"block":"none").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/menu arrow down b.png").attr("x",reverse?50:width-80).attr("y",lastY+barHeight).attr("height",barHeight/1.7).attr("width",barHeight/1.7).style("cursor","pointer").on("click",function(){q.d3stopPropagation();from+=SCROLL_STEPS;to+=SCROLL_STEPS;writeCountriesDropdown(from,to,orderedCountries,reverse,marginLeft,rightRectangleX,topSpace,barHeight,textWidth,maxBarWidth,true)})}if(from>0){gCompositionChart.append("image").attr("class","composition-chart-dropdown-analysing").style("display",byScroll?"block":"none").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/menu arrow up b.png").attr("x",reverse?80:width-50).attr("y",lastY+barHeight).attr("height",barHeight/1.7).attr("width",barHeight/1.7).style("cursor","pointer").on("click",function(){q.d3stopPropagation();from-=SCROLL_STEPS;to-=SCROLL_STEPS;writeCountriesDropdown(from,to,orderedCountries,reverse,marginLeft,rightRectangleX,topSpace,barHeight,textWidth,maxBarWidth,true)})}}function showCompositionChartDonut(name,v1,v2,v3,sum,reverse,wholeSum){q.d3stopPropagation();d3.selectAll(".efsa-pesticide-expanded-circle-text").style("display","none");compositionChartDonutExpanded=true;show(d3.select("#composition-chart-cover"));show(hiddenCircle);show(gHiddenCircle);hide(gHiddenCircleContentCountry);hide(gHiddenCircleContentPie);show(gHiddenCircleContentDonut);show(gHiddenCircleArcs);hiddenCircle.attr("stroke-width",EXPANDED_RADIUS/10).transition().duration(TIME).attr("r",EXPANDED_RADIUS).on("end",function(){donut(v1,v2,v3);var tcountry=dictionary.countries[name];tcountry=tcountry?tcountry:name;d3.select("#efsa-pesticide-expanded-circle-rect-text-0").style("display","block").text(dictionary.global.all_countries);d3.select("#efsa-pesticide-expanded-circle-rect-text-1").style("display","block").text(tcountry+" | "+q.numberWithCommas(wholeSum,ths)+" "+dictionary.global.samples).attr("transform","translate("+-EXPANDED_RADIUS/10+",0)");d3.select("#efsa-pesticide-expanded-circle-rect-0").attr("x",0).attr("width",0).attr("transform","translate(0,0)").style("display","block").style("cursor","pointer");d3.select("#efsa-pesticide-expanded-circle-rect-1").attr("x",0).attr("width",0).attr("transform","translate(0,0)").style("display","block").style("cursor","default");d3.select("#efsa-pesticide-expanded-circle-rect-text-0").attr("x",0).attr("width",0).attr("transform","translate(0,0)").style("display","block");d3.select("#efsa-pesticide-expanded-circle-rect-text-1").attr("x",0).attr("width",0).attr("transform","translate(0,0)").style("display","block");var rectText0W=d3.select("#efsa-pesticide-expanded-circle-rect-text-0")._groups[0][0].getBBox().width;var rectText1W=d3.select("#efsa-pesticide-expanded-circle-rect-text-1")._groups[0][0].getBBox().width;if(reverse){var rect0W=EXPANDED_RADIUS+EXPANDED_RADIUS/9+rectText0W;var rect0Y=tabHeight+tabSpace+tabSpace;d3.select("#efsa-pesticide-expanded-circle-rect-0").attr("transform","translate(0,"+rect0Y+")");d3.select("#efsa-pesticide-expanded-circle-rect-0").transition().duration(TIME).attr("width",rect0W).attr("transform","translate(0,"+rect0Y+")");d3.select("#efsa-pesticide-expanded-circle-rect-text-0").attr("transform","translate(0,"+rect0Y+")");d3.select("#efsa-pesticide-expanded-circle-rect-text-0").transition().duration(TIME).attr("transform","translate("+(rect0W-rectText0W-15)+","+rect0Y+")");var rect1W=EXPANDED_RADIUS+EXPANDED_RADIUS/9+rectText1W;d3.select("#efsa-pesticide-expanded-circle-rect-1").transition().duration(TIME).attr("width",rect1W).attr("transform","translate("+-rect1W+",0)");d3.select("#efsa-pesticide-expanded-circle-rect-text-1").transition().duration(TIME).attr("transform","translate("+-(rect1W-15)+",0)")}else{var rect0W=EXPANDED_RADIUS+EXPANDED_RADIUS/9+rectText0W;var rect0Y=tabHeight+tabSpace+tabSpace;d3.select("#efsa-pesticide-expanded-circle-rect-0").attr("transform","translate(0,"+rect0Y+")");d3.select("#efsa-pesticide-expanded-circle-rect-0").transition().duration(TIME).attr("width",rect0W).attr("transform","translate("+-rect0W+","+rect0Y+")");d3.select("#efsa-pesticide-expanded-circle-rect-text-0").attr("transform","translate(0,"+rect0Y+")");d3.select("#efsa-pesticide-expanded-circle-rect-text-0").transition().duration(TIME).attr("transform","translate("+-(rect0W-15)+","+rect0Y+")");var rect1W=EXPANDED_RADIUS+EXPANDED_RADIUS/9+rectText1W;d3.select("#efsa-pesticide-expanded-circle-rect-1").transition().duration(TIME).attr("width",rect1W);d3.select("#efsa-pesticide-expanded-circle-rect-text-1").transition().duration(TIME).attr("transform","translate("+(rect1W-rectText1W-15)+",0)")}gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-composition-donut").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-composition-donut-text").remove();setTimeout(function(){gHiddenCircle.append("rect").attr("id","efsa-pesticide-expanded-circle-rect-close-composition-donut").attr("x",rect1W+2).attr("y",-EXPANDED_RADIUS+EXPANDED_RADIUS/10+tabHeight+5+(reverse?tabSpace:0)).attr("width",tabHeight).attr("height",tabHeight).attr("fill","#a8a8a8").attr("cursor","pointer").on("click",function(){q.d3stopPropagation();hide(gHiddenCircleContentDonut);hide(gHiddenCircleArcs);gHiddenCircleArcs.selectAll("*").remove();d3.select(this).remove();outsideClick()}).on("mouseover",function(){d3.select("#efsa-pesticide-expanded-circle-rect-close-composition-donut-text").style("text-decoration","underline")}).on("mouseout",function(){d3.select("#efsa-pesticide-expanded-circle-rect-close-composition-donut-text").style("text-decoration","none")});gHiddenCircle.append("text").attr("id","efsa-pesticide-expanded-circle-rect-close-composition-donut-text").attr("x",rect1W+2+tabHeight/2).attr("y",-EXPANDED_RADIUS+EXPANDED_RADIUS/10+tabHeight+5+tabHeight/2+FONT_NORMAL/2.5+(reverse?tabSpace:0)).attr("text-anchor","middle").attr("fill","white").style("font-size",FONT_BIG*1.25+"px").text("x");if(reverse){var temp=gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-composition-donut");var tempx=+temp.attr("x");var tempw=+temp.attr("width");temp.attr("transform","translate("+-(tempx*2+tempw)+","+-tabSpace+")");var temp=gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-composition-donut-text");var tempx=+temp.attr("x");var tempw=+temp.attr("width");temp.attr("transform","translate("+-(tempx*2+tempw)+","+-tabSpace+")")}},TIME)})}function compositionChartItemMouseOver(that,id){d3.select(that).attr("fill","#3878b2");d3.select(id).attr("fill","#ffffff")}function compositionChartItemMouseOut(that,id,background,foreground){d3.select(that).attr("fill",background);d3.select(id).attr("fill",foreground)}function donut(value_below_loq,value_below_mrl,value_above_mrl){var counterIters=10;if(!donutShown){counterIters=10;d3.selectAll(".efsa-pesticide-expanded-circle-text").style("display","none").transition().duration(0).delay(function(d,i){return 2*TIME+30*i}).style("display","block");donutShown=true}hiddenCircle.attr("stroke-width",EXPANDED_RADIUS/10).transition().duration(TIME).attr("r",EXPANDED_RADIUS).on("end",function(){var v1=value_below_loq
;var v2=value_below_mrl;var v3=value_above_mrl;var vs=[v1,v2,v3];v1/=100;v2/=100;v3/=100;var texts=d3.selectAll(".efsa-pesticide-expanded-circle-text-value");for(var i=0;i<3;i++){var d3node=d3.select(texts._groups[0][i]);var currentValue=parseInt(d3node.text());if(isNaN(currentValue)){currentValue=0}counterAnimation(d3node,currentValue,vs[i],"%",1,counterIters)}var wholeTime=TIME/2;var innerRadius=EXPANDED_RADIUS-EXPANDED_RADIUS/10-EXPANDED_RADIUS/20-EXPANDED_RADIUS/10;var outerRadius=EXPANDED_RADIUS-EXPANDED_RADIUS/10-EXPANDED_RADIUS/20;arc(gHiddenCircleArcs,0,v1,DONUT_COLOR_1,wholeTime*v1,innerRadius,outerRadius,function(){arc(gHiddenCircleArcs,v1,v1+v2,DONUT_COLOR_2,wholeTime*v2,innerRadius,outerRadius,function(){arc(gHiddenCircleArcs,v1+v2,v1+v2+v3,DONUT_COLOR_3,wholeTime*v3,innerRadius,outerRadius)})});setTimeout(function(){for(var wti=1;wti<=3;wti++){var wt=d3.select("#efsa-pesticide-expanded-circle-text-"+wti)._groups[0][0].getBBox().width;d3.select("#efsa-pesticide-expanded-circle-text-"+wti+"c").attr("cx",-wt/2-5)}},TIME*3)})}function outsideClick(){if(!readyToUser||shifting){return}if(!KEEP_MENU_OPEN_ONCE_MORE){closeTab()}removeDelightCircles();if(type==="food"){if(leftShifted){positionCircles(true)}}if(KEEP_MENU_OPEN_ONCE_MORE){KEEP_MENU_OPEN_ONCE_MORE=false}if(expanded||compositionChartDonutExpanded){closeExpanded()}if(mobile&&shown!==-1){unshowCircleContent(null,shown,false)}circle.style("cursor","pointer");gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-composition-donut").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-composition-donut-text").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-food-name").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-food-name-text").remove();hide(d3.selectAll(".composition-chart-dropdown-analysing"));faked=-1;if(compositionChartDonutExpanded){setTimeout(function(){hide(d3.select("#composition-chart-cover"))},TIME*2)}}function closeExpanded(){removeExpandedCircleIconsAndClose();removeHiddenCircleTexts();hide(gHiddenCircleContentDonut);hide(gHiddenCircleArcs);hide(gHiddenCircleContentPie);hide(gHiddenCircleContentCountry);collapseCircleLabels(function(){removeExpandedCircleContent(true);removeDelightCircles();removeHiddenCircle(true);expanded=false;expandedName=null;expandedType=null;compositionChartDonutExpanded=false;unshowing=false;donutShown=false;pieShown=false})}function tick(){if(unshowing){return}if(type==="country"){d3.selectAll(".country-code").each(function(d,i){d3.select(this).attr("x",d3.select("#efsa-pesticide-food-"+i).attr("cx")).attr("y",+d3.select("#efsa-pesticide-food-"+i).attr("cy")+FONT_NORMAL/2)})}circle.attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}).attr("index",function(d){return d.index})}function forceCluster(alpha){for(var i=0,n=nodesLength,node,cluster,k=alpha*1;i<n;++i){node=nodes[i];cluster=clusters[node.cluster];node.vx-=(node.x-cluster.x)*k;node.vy-=(node.y-cluster.y)*k}}function collide(){if(!FORCE_REFRESH&&savedNodes){for(var n=0;n<nodesLength;n++){nodes[n].fx=+savedNodes[n].cx;nodes[n].fy=+savedNodes[n].cy;nodes[n].x=+savedNodes[n].cx;nodes[n].y=+savedNodes[n].cy}}gCircles.attr("opacity",1);gCircles.selectAll(".efsa-pesticide-food").attr("r",0).attr("opacity",1);if(FORCE_REFRESH){gCircles.selectAll(".efsa-pesticide-food").attr("r",10)}var forceCollide=d3.forceCollide().radius(function(d){return d.radius+1}).iterations(mobile||isIE?4:10);var decay=FORCE_REFRESH?.015:.8;force=d3.forceSimulation().nodes(nodes).force("center",d3.forceCenter()).force("collide",forceCollide).force("cluster",forceCluster).force("gravity",d3.forceManyBody().strength(-20)).force("x",d3.forceX().strength(1)).force("y",d3.forceY().strength(1)).alphaDecay(decay).on("tick",tick).on("end",function(){for(var n=0,x=nodesLength;n<x;n++){var node=nodes[n];backup.push({x:node.x,y:node.y,radius:node.radius})}var toFood=0;var expTime=type==="food"?TIME*2:TIME*3;var delTime=type==="food"?TIME/5:TIME/25;gCircles.selectAll(".efsa-pesticide-food").transition().ease(q.qeaseElastic).duration(expTime).delay(function(d,i){toFood++;return 200+i%20*delTime}).attr("r",function(){return d3.select(this).attr("r-val")}).on("end",function(){toFood--;if(toFood===0){start()}});if(FORCE_REFRESH){console.info("SAVING");saveForced()}if(type==="country"){setTimeout(function(){for(var n=0;n<nodesLength;n++){nodes[n].fx=null;nodes[n].fy=null}force.nodes(nodes).alphaTarget(.007).alphaDecay(.8).restart();setTimeout(function(){backup=[];for(var n=0,x=nodesLength;n<x;n++){var node=nodes[n];backup.push({x:node.x,y:node.y,radius:node.radius})}},2e3)},100)}})}function prestart(){circle=gCircles.selectAll(".efsa-pesticide-food").data(nodes).enter().append("circle").attr("id",function(d,i){return"efsa-pesticide-food-"+i}).attr("class","efsa-pesticide-food").attr("stroke-width",0).attr("r",function(d){return d.radius}).attr("r-val",function(d){return d.radius}).attr("data-category",function(d){return d.category}).attr("data-subcategory",function(d){return d.subcategory}).attr("data-food",function(d){return d.food}).attr("fill-val",function(d){return type==="food"?color(d.cluster):COUNTRIES_BUBBLES_COLOR}).attr("fill",function(d){return type==="food"?color(d.cluster):COUNTRIES_BUBBLES_COLOR}).attr("cx",function(d){return d.x}).attr("cy",function(d){return d.y}).attr("cx-val",function(d){return d.x}).attr("cy-val",function(d){return d.y}).style("cursor","pointer");if(type==="country"){circle.each(function(d,i){var item=d3.select(this);gCircles.append("text").style("opacity","0").attr("class","country-code").attr("text-anchor","middle").attr("x",item.attr("cx")).attr("y",+item.attr("cy")).text(d.countrycode).attr("fill",COUNTRIES_CODE_COLOR).attr("font-weight","700").attr("font-size",FONT_NORMAL).transition().duration(500).delay(function(){return 1e3+i*30}).style("opacity","1")})}if(type==="country"){circle.attr("stroke",COUNTRIES_BUBBLE_STROKE).attr("stroke-width",COUNTRIES_BUBBLE_STROKE_WIDTH)}var ecr=[1,2,3,4];gHiddenCircleCircle.selectAll(".efsa-pesticide-expanded-circle-rect").data(ecr).enter().append("rect").attr("class","efsa-pesticide-expanded-circle-rect").attr("id",function(d,i){return"efsa-pesticide-expanded-circle-rect-"+i}).attr("y",function(d,i){return-EXPANDED_RADIUS+EXPANDED_RADIUS/10+i*(tabHeight+5)}).attr("height",type==="food"?tabHeight:tabHeight).style("display","none");gHiddenCircleCircle.selectAll(".efsa-pesticide-expanded-circle-rect-text").data(ecr).enter().append("text").style("font-size",function(d,i){return(i===0?FONT_BIG:(FONT_BIG+FONT_NORMAL)/2)+"px"}).attr("class","efsa-pesticide-expanded-circle-rect-text").attr("id",function(d,i){return"efsa-pesticide-expanded-circle-rect-text-"+i}).attr("y",function(d,i){var fs=i===0?FONT_BIG:(FONT_BIG+FONT_NORMAL)/2;return-EXPANDED_RADIUS+EXPANDED_RADIUS/10+i*(tabHeight+5)+tabHeight/2+fs/2.5});if(type==="food"){gHiddenCircleCircle.append("image").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/sub-category.png").style("display","none").style("pointer-events","none").attr("height",tabHeight*.7).attr("width",tabHeight*.7).attr("x",EXPANDED_RADIUS+EXPANDED_RADIUS/10+2).attr("y",function(d,i){return-EXPANDED_RADIUS+EXPANDED_RADIUS/10+2*(tabHeight+5)+3}).attr("id","efsa-pesticide-expanded-circle-rect-icon-sub-category")}if(type==="country"){gHiddenCircleCircle.append("image").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/pie chart.png").style("display","none").style("pointer-events","none").attr("height",tabHeight*.7).attr("width",tabHeight*.7).attr("class","efsa-pesticide-expanded-circle-rect-icon").attr("id","efsa-pesticide-expanded-circle-rect-icon-pie-chart").attr("y",function(){var i=1;return-EXPANDED_RADIUS+EXPANDED_RADIUS/10+i*(tabHeight+5)+tabHeight*.15}).attr("x",EXPANDED_RADIUS+EXPANDED_RADIUS/9*1-tabHeight);gHiddenCircleCircle.append("image").attr("xlink:href","/sites/default/files/interactive_tools/pesticides_2017/assets/map marker.png").style("display","none").style("pointer-events","none").attr("height",tabHeight*.7).attr("width",tabHeight*.7).attr("class","efsa-pesticide-expanded-circle-rect-icon").attr("id","efsa-pesticide-expanded-circle-rect-icon-map-marker").attr("y",function(){var i=2;return-EXPANDED_RADIUS+EXPANDED_RADIUS/10+i*(tabHeight+5)+tabHeight*.15}).attr("x",EXPANDED_RADIUS+EXPANDED_RADIUS/9*2-tabHeight)}hiddenCircle=gHiddenCircleCircle.append("circle").attr("r",0).attr("fill","white").attr("stroke-width",0).attr("pointer-events","none");hiddenText=gHiddenCircleCircle.append("text").attr("class","efsa-pesticide-clicked-circle-text").style("font-size",FONT_NORMAL+"px");hiddenValue=gHiddenCircleCircle.append("text").attr("class","efsa-pesticide-clicked-circle-text").style("font-weight","700").style("font-size",FONT_BIG+"px");hiddenValueLegend=gHiddenCircleCircle.append("text").attr("class","efsa-pesticide-clicked-circle-text").style("font-weight","300").style("font-size",FONT_NORMAL+"px");if(type==="food"){hiddenButton=gHiddenCircleCircle.append("rect").attr("rx",10).attr("ry",10).attr("width",94).attr("height",20).attr("pointer-events","none").style("display","none");hiddenButtonText=gHiddenCircleCircle.append("text").attr("fill","white").attr("font-size","10px").text(dictionary.global.see_results).attr("pointer-events","none").attr("text-anchor","middle").style("font-weight","400").style("display","none");var hiddenButtonTextWidth=0;if(isIE||isFF||isSaf){hiddenButtonTextWidth=hiddenButtonText.text().length*5}else{hiddenButtonText.style("display","block");hiddenButtonTextWidth=hiddenButtonText._groups[0][0].getBBox().width;hiddenButtonText.style("display","none")}if(hiddenButtonTextWidth>85){hiddenButtonText.attr("font-size","9px")}}if(type==="food"){setupHiddenCircleContentDonut()}else if(type==="country"){setupHiddenCircleContentDonut();hide(gHiddenCircleContentDonut);hide(gHiddenCircleArcs);setupHiddenCircleContentPie();hide(gHiddenCircleContentPie);setupHiddenCircleContentCountry()}}function setupHiddenCircleContentCountry(){var num1Y=-EXPANDED_RADIUS/2.2+FONT_BIG*3;var num2Y=-EXPANDED_RADIUS/2.2+FONT_BIG*10;gHiddenCircleContentCountry.append("text").attr("class","efsa-pesticide-expanded-circle-text-for-country").attr("x",0).attr("y",-EXPANDED_RADIUS/1.5).style("font-size",FONT_BIG+"px").text("");gHiddenCircleContentCountry.append("text").attr("class","efsa-pesticide-expanded-circle-text-for-country").attr("x",0).attr("y",num1Y).style("font-size",FONT_BIG*2+"px").text("");gHiddenCircleContentCountry.append("text").attr("class","efsa-pesticide-expanded-circle-text-for-country").attr("x",0).attr("y",-EXPANDED_RADIUS/2.2+FONT_BIG*5).style("font-size",FONT_BIG+"px").text("");gHiddenCircleContentCountry.append("text").attr("class","efsa-pesticide-expanded-circle-text-for-country").attr("x",0).attr("y",num2Y).style("font-size",FONT_BIG*2+"px").text("");gHiddenCircleContentCountry.append("text").attr("class","efsa-pesticide-expanded-circle-text-for-country").attr("x",0).attr("y",-EXPANDED_RADIUS/2.2+FONT_BIG*12).style("font-size",FONT_BIG+"px").text("");gHiddenCircleContentCountry.append("text").attr("class","efsa-pesticide-expanded-circle-text-for-country").attr("x",0).attr("y",-EXPANDED_RADIUS/2.2+FONT_BIG*13).style("font-size",FONT_BIG+"px").text("");gHiddenCircleContentCountry.append("line").attr("class","efsa-pesticide-expanded-circle-line").attr("x1",-EXPANDED_RADIUS/2).attr("y1",-EXPANDED_RADIUS/2).attr("x2",+EXPANDED_RADIUS/2).attr("y2",-EXPANDED_RADIUS/2);gHiddenCircleContentCountry.append("line").attr("class","efsa-pesticide-expanded-circle-line").attr("x1",-EXPANDED_RADIUS/2).attr("y1",(num2Y+num1Y)/2).attr("x2",+EXPANDED_RADIUS/2).attr("y2",(num2Y+num1Y)/2)}function setupHiddenCircleContentDonut(){var EXPANDED_CIRCLE_LEGEND_DOT_RADIUS=mobile?3:7;gHiddenCircleContentDonut.append("text").attr("class","efsa-pesticide-expanded-circle-text").attr("id","efsa-pesticide-expanded-circle-text-1").attr("fill",DONUT_COLOR_1).attr("x",10).attr("y",-EXPANDED_RADIUS/2.5).text(dictionary.global.below_loq).style("font-size",FONT_BIG*1.1+"px");gHiddenCircleContentDonut.append("text").attr("class","efsa-pesticide-expanded-circle-text efsa-pesticide-expanded-circle-text-value").attr("fill",DONUT_COLOR_1).attr("x",10).attr("y",-EXPANDED_RADIUS/2.5+30).text("0.00%").style("font-size",FONT_BIG*1.5+"px");gHiddenCircleContentDonut.append("text").attr("class","efsa-pesticide-expanded-circle-text").attr("id","efsa-pesticide-expanded-circle-text-2").attr("fill",DONUT_COLOR_2).attr("x",10).attr("y",0).text(dictionary.global.between_loq_and_mrl).style("font-size",FONT_BIG*1.1+"px");gHiddenCircleContentDonut.append("text").attr("class","efsa-pesticide-expanded-circle-text efsa-pesticide-expanded-circle-text-value").attr("fill",DONUT_COLOR_2).attr("x",10).attr("y",30).text("0.00%").style("font-size",FONT_BIG*1.5+"px");gHiddenCircleContentDonut.append("text").attr("class","efsa-pesticide-expanded-circle-text").attr("id","efsa-pesticide-expanded-circle-text-3").attr("fill",DONUT_COLOR_3).attr("x",10).attr("y",EXPANDED_RADIUS/2.5).text(dictionary.global.above_mrl).style("font-size",FONT_BIG*1.1+"px");gHiddenCircleContentDonut.append("text").attr("class","efsa-pesticide-expanded-circle-text efsa-pesticide-expanded-circle-text-value").attr("fill",DONUT_COLOR_3).attr("x",10).attr("y",EXPANDED_RADIUS/2.5+30).text("0.00%").style("font-size",FONT_BIG*1.5+"px");gHiddenCircleContentDonut.append("circle").attr("class","efsa-pesticide-expanded-circle-text").attr("id","efsa-pesticide-expanded-circle-text-1c").attr("cx",-EXPANDED_RADIUS/2+50).attr("cy",-EXPANDED_RADIUS/2.5-7).attr("r",EXPANDED_CIRCLE_LEGEND_DOT_RADIUS).attr("fill",DONUT_COLOR_1);gHiddenCircleContentDonut.append("circle").attr("class","efsa-pesticide-expanded-circle-text").attr("id","efsa-pesticide-expanded-circle-text-2c").attr("cx",-EXPANDED_RADIUS/2+5).attr("cy",-7).attr("r",EXPANDED_CIRCLE_LEGEND_DOT_RADIUS).attr("fill",DONUT_COLOR_2);gHiddenCircleContentDonut.append("circle").attr("class","efsa-pesticide-expanded-circle-text").attr("id","efsa-pesticide-expanded-circle-text-3c").attr("cx",-EXPANDED_RADIUS/2+50).attr("cy",EXPANDED_RADIUS/2.5-7).attr("r",EXPANDED_CIRCLE_LEGEND_DOT_RADIUS).attr("fill",DONUT_COLOR_3);var mul=mobile?4:5;var w;if(isIE||isFF||isSaf){for(var i=1;i<=3;i++){w=d3.select("#efsa-pesticide-expanded-circle-text-"+i).text().length;d3.select("#efsa-pesticide-expanded-circle-text-"+i+"c").attr("cx",-w*mul)}}else{for(var i=1;i<=3;i++){w=d3.select("#efsa-pesticide-expanded-circle-text-"+i)._groups[0][0].getBBox().width;d3.select("#efsa-pesticide-expanded-circle-text-"+i+"c").attr("cx",-w/2-5)}}}function setupHiddenCircleContentPie(){gHiddenCircleArcs.selectAll("*").remove();gHiddenCircleContentPie.append("g").attr("class","efsa-pesticide-expanded-circle-pie")}function start(){if(FORCE_REFRESH){console.info("START")}gTabs.selectAll(".efsa-pesticide-tab").transition().duration(TIME/2).delay(function(d,i){return i*(TIME/6)}).attr("transform","translate(0,0)");readyToUser=true;d3.select("#efsa-pesticide-loading").transition().duration(TIME*2).style("background-color","rgba(255,255,255,0)").on("end",function(){hide(d3.select("#efsa-pesticide-loading"))});events()}function saveForced(){var xydata=[];gCircles.selectAll("circle").each(function(item){var index=d3.select(this).attr("index");var cx=d3.select(this).attr("cx");var cy=d3.select(this).attr("cy");xydata[index]={cx:cx,cy:cy}});var data={};data["width"]=width;data["height"]=height;data["data"]=xydata;d3.request("saveForced.php").header("X-Requested-With","XMLHttpRequest").header("Content-Type","application/x-www-form-urlencoded").post("type="+type+"&data="+JSON.stringify(data),function(){})}function positionCircles(anim){shifting=true;gHiddenCircle.attr("transform","translate("+width/2+","+height/2+")");leftShifted=false;if(anim){var toshift=0;gCircles.selectAll(".efsa-pesticide-food").transition().duration(TIME).ease(q.qeaseElastic).delay(function(d,i){toshift++;var delay=width/5-+d3.select(this).attr("cx")/2;if(delay<0){delay=0}return delay}).attr("transform","translate(0,0)").on("end",function(){toshift--;if(!toshift){shifting=false;leftShifted=false}else{shifting=true}})}else{shifting=false;gCircles.attr("transform","translate("+width/2+","+height/2+")");gCircles.selectAll(".efsa-pesticide-food").attr("transform","translate(0,0)")}}function shiftCircles(callback){if(mobile){return}shifting=true;var toshift=0;gCircles.selectAll(".efsa-pesticide-food").transition().ease(q.qeaseElastic).duration(TIME).delay(function(d,i){toshift++;var delay=width/4+ +d3.select(this).attr("cx")/2;if(delay<0){delay=0}return delay}).attr("transform","translate(+"+width/5+", 0)").on("end",function(){toshift--;if(!toshift){shifting=false;leftShifted=true;callback()}else{shifting=true}})}function arc(container,start,end,color,mytime,innerRadius,outerRadius,callback){if(mobile){mytime=0}var tau=2*q.pi;var arc=d3.arc().innerRadius(innerRadius).outerRadius(outerRadius).startAngle(start*tau);container.append("path").datum({endAngle:start*tau}).attr("fill",color).attr("d",arc).transition().duration(mytime).ease(d3.easeLinear).attrTween("d",arcTween(end*tau)).on("end",callback);function arcTween(newAngle){return function(d){var interpolate=d3.interpolate(d.endAngle,newAngle);return function(t){d.endAngle=interpolate(t);return arc(d)}}}}function removeExpandedCircleContent(delayHiddenCircleGroupHiding){gHiddenCircleArcs.text("");gHiddenCircleArcs.html("");if(delayHiddenCircleGroupHiding){setTimeout(function(){hide(gHiddenCircle)},TIME*1.2)}else{hide(gHiddenCircle)}if(type==="food"){hide(gHiddenCircleContentDonut)}else if(type==="country"){hide(gHiddenCircleContentCountry)}hide(d3.selectAll(".efsa-pesticide-expanded-circle-rect"));hide(d3.selectAll(".efsa-pesticide-expanded-circle-rect-text"));removeExpandedCircleIconsAndClose()}function removeExpandedCircleIconsAndClose(){d3.select("#efsa-pesticide-expanded-circle-rect-icon-sub-category").style("display","none");hide(d3.select("#efsa-pesticide-expanded-circle-rect-icon-pie-chart"));hide(d3.select("#efsa-pesticide-expanded-circle-rect-icon-map-marker"));gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-all").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-all-text").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-pie-chart").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-pie-chart-text").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-map-marker").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-map-marker-text").remove()}function fakeExpand(d,i){faked=i;for(var n=0;n<nodesLength;n++){if(n!==i){nodes[n].fx=null;nodes[n].fy=null}}nodes[i].radius=backup[i].radius+backup[i].radius*.3;d3.select("#efsa-pesticide-food-"+i).transition().duration(TIME*2).ease(q.qeaseElastic).attr("r",nodes[i].radius);force.nodes(nodes).alphaTarget(.002).alphaDecay(.8).restart()}function fakeUnexpand(d,i){faked=-1;for(var n=0;n<nodesLength;n++){if(n!==i){nodes[n].fx=null;nodes[n].fy=null}}nodes[i].radius=backup[i].radius;d3.select("#efsa-pesticide-food-"+i).transition().duration(TIME*2).ease(q.qeaseElastic).attr("r",nodes[i].radius);force.nodes(nodes).alphaTarget(mobile?.003:.001).alphaDecay(.8).restart()}function events(){d3.selectAll(".efsa-pesticide-tab").on("click",toggleSubtab);if(mobile){circle.on("click",function(d,i){q.d3stopPropagation();if(shifting||!readyToUser){return}var now=+new Date;if(now-lastBubbleClickTime<TIME){return}lastBubbleClickTime=now;if((shown===-1||shown!==d.index)&&type==="food"){if(shown===-1){showCircleContent(d,i)}else{unshowCircleContent(null,shown,false);setTimeout(function(){showCircleContent(d,i)},TIME)}return}else{if(type==="food"){unshowCircleContent(d,i,false);var color=d.color;var category=d.category;var subcategory=d.subcategory;var v1=+d.value_below_loq;var v2=+d.value_below_mrl;var v3=+d.value_above_mrl;var name=d.food;var samples=+d.samples;expandHiddenCircle(color,category,subcategory,name,samples,v1,v2,v3,ITEM);setTimeout(function(){shiftCircles(function(){})},TIME)}else if(type==="country"){unshowCircleContent(d,i,false);showHiddenCircleGroup();expandHiddenCircle(GRAY,"countries",d.subcategory,d.food,[d.samples,d.inhabitants],50,20,30,ITEM)}}});d3.selectAll(".efsa-pesticide-subtab").on("click",function(d){if(shifting){return}delightCirclesExceptSubcategory();show(hiddenCircle);showSubcategoryCircleContent(d,d3.select(this).attr("fill"))});d3.selectAll(".efsa-pesticide-tab-title").on("click",function(d,i){q.d3stopPropagation();if(!d){outsideClick();return}toggleSubtab(d);showCategoryCircleContent(d,d3.select(this).attr("fill"))})}else{circle.on("mouseover",function(d,i){if(expanded){return}if(shown>-1){return}if(unshowing||shifting||!readyToUser){return}var color=type==="food"?d3.select(this).attr("fill-val"):"gray";var opa=+d3.select(this).attr("opacity");if(opa===1){var name=d.food;if(type==="food"){name=dictionary.foods[name]}else{name=dictionary.countries[name]}moveTooltip(+d3.select(this).attr("cx")+width/2-d.radius/3,+d3.select(this).attr("cy")+height/2-d.radius/3,name,color,d3.select(this).attr("index"))}});circle.on("mousemove",function(d,i){if(expanded){return}if(shown>-1){return}if(unshowing||shifting||!readyToUser){return}if(faked>-1){return}fakeExpand(d,i)});circle.on("mouseout",function(d,i){hideTooltip(d3.select(this).attr("index"));if(unshowing||shifting||!readyToUser){return}if(expanded){return}if(shown===-1){fakeUnexpand(d,i)}else{unshowCircleContent(d,i,true);setTimeout(function(){fakeUnexpand(d,i)},TIME*.7)}});circle.on("click",function(d,i){q.d3stopPropagation();if(type==="country"){fakeUnexpand(d,i)}hideTooltip(-999);if(expanded||leftShifted||shifting||!readyToUser){return}var now=+new Date;if(now-lastBubbleClickTime<TIME){return}lastBubbleClickTime=now;if(shown===-1&&type==="food"){showCircleContent(d,i);return}if(type==="food"){unshowCircleContent(d,i,false);var color=d.color;var category=d.category;var subcategory=d.subcategory;var v1=+d.value_below_loq;var v2=+d.value_below_mrl;var v3=+d.value_above_mrl;var name=d.food;var samples=+d.samples;expandHiddenCircle(color,category,subcategory,name,samples,v1,v2,v3,ITEM);setTimeout(function(){shiftCircles(function(){})},TIME)}else if(type==="country"){unshowCircleContent(d,i,false);showHiddenCircleGroup();expandHiddenCircle(GRAY,"countries",d.subcategory,d.food,[d.samples,d.inhabitants],50,20,30,ITEM)}});hiddenCircle.on("mouseout",function(){if(!expanded){outsideClick()}});d3.selectAll(".efsa-pesticide-subtab").on("mouseover",delightCirclesExceptSubcategory);d3.selectAll(".efsa-pesticide-subtab").on("mouseout",delightSubtab);d3.selectAll(".efsa-pesticide-subtab").on("click",function(d){if(shifting){return}show(hiddenCircle);showSubcategoryCircleContent(d,d3.select(this).attr("fill"))});d3.selectAll(".efsa-pesticide-tab-title").on("mouseover",function(d,i){if(!d){return}delightCirclesExceptCategory(categories[i])});d3.selectAll(".efsa-pesticide-tab-title").on("mouseout",function(d,i){if(shifting||leftShifted){return}circle.style("cursor","pointer").transition().duration(TIME).attr("opacity",1)});d3.selectAll(".efsa-pesticide-tab-title").on("click",function(d){q.d3stopPropagation();if(!d){outsideClick();return}toggleSubtab(d);showCategoryCircleContent(d,d3.select(this).attr("fill"))})}if(type==="country"){d3.selectAll(".efsa-pesticide-expanded-circle-rect").on("click",function(d,i){q.d3stopPropagation();hideTooltip(-1);if(i===0){if(compositionChartDonutExpanded){closeCompositionChart()}}else if(i===1){if(!compositionChartDonutExpanded){gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-map-marker").remove();hide(gHiddenCircleContentCountry);hide(gHiddenCircleContentPie);show(gHiddenCircleContentDonut);show(gHiddenCircleArcs);donut(sideData1[expandedName].value_below_loq,sideData1[expandedName].value_below_mrl,sideData1[expandedName].value_above_mrl);var labelToMove;labelToMove=d3.select("#efsa-pesticide-expanded-circle-rect-1");labelToMove.style("cursor","default");labelToMove.transition().duration(TIME).attr("transform",function(d){return"translate("+-labelToMove.attr("width")+",0)"}).on("end",function(){show(d3.select("#efsa-pesticide-expanded-circle-rect-0"));show(d3.select("#efsa-pesticide-expanded-circle-rect-text-0"))});d3.select("#efsa-pesticide-expanded-circle-rect-text-1").transition().duration(TIME).attr("transform",function(d){return"translate("+(-2*labelToMove.attr("width")+d3.select(this)._groups[0][0].getBBox().width+15+tabHeight)+",0)"});d3.select("#efsa-pesticide-expanded-circle-rect-icon-pie-chart").transition().duration(TIME).attr("transform",function(d){return"translate("+(-2*labelToMove.attr("width")+d3.select("#efsa-pesticide-expanded-circle-rect-text-1")._groups[0][0].getBBox().width+15+tabHeight)+",0)"});labelToMove=d3.select("#efsa-pesticide-expanded-circle-rect-2");labelToMove.style("cursor","pointer");labelToMove.transition().duration(TIME).attr("transform","translate(0,0)");d3.select("#efsa-pesticide-expanded-circle-rect-text-2").transition().duration(TIME).attr("transform","translate(0,0)");d3.select("#efsa-pesticide-expanded-circle-rect-icon-map-marker").transition().duration(TIME).attr("transform","translate(0,0)").on("end",function(){gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-pie-chart").remove();gHiddenCircle.append("rect").attr("id","efsa-pesticide-expanded-circle-rect-close-pie-chart").attr("x",-d3.select("#efsa-pesticide-expanded-circle-rect-1").attr("width")-tabHeight-2).attr("y",-EXPANDED_RADIUS+EXPANDED_RADIUS/10+tabHeight+5).attr("width",tabHeight).attr("height",tabHeight).attr("fill","#a8a8a8").attr("cursor","pointer").on("click",function(){var labelToMove=d3.select("#efsa-pesticide-expanded-circle-rect-1");labelToMove.transition().duration(TIME).attr("transform","translate(0,0)");labelToMove.style("cursor","pointer");d3.select("#efsa-pesticide-expanded-circle-rect-text-1").transition().duration(TIME).attr("transform","translate(0,0)");d3.select("#efsa-pesticide-expanded-circle-rect-icon-pie-chart").transition().duration(TIME).attr("transform","translate(0,0)");gHiddenCircleArcs.selectAll("*").remove();hide(gHiddenCircleContentDonut);hide(gHiddenCircleArcs);show(gHiddenCircleContentCountry);gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-pie-chart").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-pie-chart-text").remove()}).on("mouseover",function(){d3.select("#efsa-pesticide-expanded-circle-rect-close-pie-chart-text").style("text-decoration","underline")}).on("mouseout",function(){d3.select("#efsa-pesticide-expanded-circle-rect-close-pie-chart-text").style("text-decoration","none")});gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-pie-chart-text").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-map-marker-text").remove();gHiddenCircle.append("text").attr("id","efsa-pesticide-expanded-circle-rect-close-pie-chart-text").attr("x",-d3.select("#efsa-pesticide-expanded-circle-rect-1").attr("width")-tabHeight-2+tabHeight/2).attr("y",-EXPANDED_RADIUS+EXPANDED_RADIUS/10+tabHeight+5+tabHeight/2+FONT_NORMAL/2.5).attr("text-anchor","middle").attr("fill","white").style("font-size",FONT_BIG*1.25+"px").text("x")})}}else if(i===2){if(!compositionChartDonutExpanded){gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-pie-chart").remove();hide(gHiddenCircleContentCountry);hide(gHiddenCircleContentDonut);hide(gHiddenCircleArcs);show(gHiddenCircleContentPie);var pieData=samples.composition[expandedName];var types={Domestic:0,EU:0,TC:0,UN:0};for(var p in pieData){types[pieData[p].type]+=+pieData[p].samples}pie(types["Domestic"],types["EU"],types["TC"],types["UN"],expandedName);setTimeout(function(){d3.select(".efsa-pesticide-expanded-circle-pie").append("rect").attr("x",-EXPANDED_RADIUS/3).attr("width",EXPANDED_RADIUS/1.5).attr("y",-FONT_BIG).attr("height",FONT_BIG*2).attr("id","efsa-pesticide-expanded-circle-pie-tooltip").attr("stroke","white").attr("display","none").attr("pointer-events","none");d3.select(".efsa-pesticide-expanded-circle-pie").append("text").attr("text-anchor","middle").attr("y",FONT_NORMAL/2).attr("font-size",FONT_NORMAL).attr("id","efsa-pesticide-expanded-circle-pie-tooltip-text").attr("fill","white").attr("display","none")},TIME*3);var labelToMove;labelToMove=d3.select("#efsa-pesticide-expanded-circle-rect-2");labelToMove.style("cursor","default");labelToMove.transition().duration(TIME).attr("transform",function(d){return"translate("+-labelToMove.attr("width")+",0)"}).on("end",function(){show(d3.select("#efsa-pesticide-expanded-circle-rect-0"));show(d3.select("#efsa-pesticide-expanded-circle-rect-text-0"))});d3.select("#efsa-pesticide-expanded-circle-rect-text-2").transition().duration(TIME).attr("transform",function(d){return"translate("+(-2*labelToMove.attr("width")+d3.select(this)._groups[0][0].getBBox().width+15+tabHeight)+",0)"});d3.select("#efsa-pesticide-expanded-circle-rect-icon-map-marker").transition().duration(TIME).attr("transform",function(d){return"translate("+(-2*labelToMove.attr("width")+d3.select("#efsa-pesticide-expanded-circle-rect-text-2")._groups[0][0].getBBox().width+15+tabHeight)+",0)"});labelToMove=d3.select("#efsa-pesticide-expanded-circle-rect-1");labelToMove.style("cursor","pointer");labelToMove.transition().duration(TIME).attr("transform","translate(0,0)");d3.select("#efsa-pesticide-expanded-circle-rect-text-1").transition().duration(TIME).attr("transform","translate(0,0)");d3.select("#efsa-pesticide-expanded-circle-rect-icon-pie-chart").transition().duration(TIME).attr("transform","translate(0,0)").on("end",function(){gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-map-marker").remove();gHiddenCircle.append("rect").attr("id","efsa-pesticide-expanded-circle-rect-close-map-marker").attr("x",-d3.select("#efsa-pesticide-expanded-circle-rect-2").attr("width")-tabHeight-2).attr("y",-EXPANDED_RADIUS+EXPANDED_RADIUS/10+2*(tabHeight+5)).attr("width",tabHeight).attr("height",tabHeight).attr("fill","#a8a8a8").attr("cursor","pointer").on("click",function(){var labelToMove=d3.select("#efsa-pesticide-expanded-circle-rect-2");labelToMove.transition().duration(TIME).attr("transform","translate(0,0)");labelToMove.style("cursor","pointer");d3.select("#efsa-pesticide-expanded-circle-rect-text-2").transition().duration(TIME).attr("transform","translate(0,0)");d3.select("#efsa-pesticide-expanded-circle-rect-icon-map-marker").transition().duration(TIME).attr("transform","translate(0,0)");gHiddenCircleArcs.selectAll("*").remove();hide(gHiddenCircleContentPie);show(gHiddenCircleContentCountry);gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-map-marker").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-map-marker-text").remove()}).on("mouseover",function(){d3.select("#efsa-pesticide-expanded-circle-rect-close-map-marker-text").style("text-decoration","underline")}).on("mouseout",function(){d3.select("#efsa-pesticide-expanded-circle-rect-close-map-marker-text").style("text-decoration","none")});gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-map-marker-text").remove();gHiddenCircle.select("#efsa-pesticide-expanded-circle-rect-close-pie-chart-text").remove();gHiddenCircle.append("text").attr("id","efsa-pesticide-expanded-circle-rect-close-map-marker-text").attr("x",-d3.select("#efsa-pesticide-expanded-circle-rect-2").attr("width")-tabHeight-2+tabHeight/2).attr("y",-EXPANDED_RADIUS+EXPANDED_RADIUS/10+2*(tabHeight+5)+tabHeight/2+FONT_NORMAL/2.5).attr("text-anchor","middle").attr("fill","white").style("font-size",FONT_BIG*1.25+"px").text("x")})}}})}gHiddenCircle.on("click",function(){q.d3stopPropagation()});hiddenCircle.on("click",function(){q.d3stopPropagation()});if(type==="food"){
d3.select("#efsa-pesticide-expanded-circle-rect-2").on("click",function(){if(expandedType===CATEGORY){var bk=expandedName;closeExpanded();unshowCircleContent(null,shown,false);setTimeout(function(){delightCirclesExceptCategory(bk)},3*TIME)}else{var bk=expandedName;closeExpanded();unshowCircleContent(null,shown,false);setTimeout(function(){delightCirclesExceptSubcategory(bk)},3*TIME)}outsideClick()})}svg.on("click",outsideClick)}function closeCompositionChart(){gHiddenCircleArcs.selectAll("*").remove();hide(gHiddenCircleContentCountry);hide(gHiddenCircleContentPie);hide(gHiddenCircleContentDonut);gCompositionChart.transition().duration(TIME).style("opacity","0").on("end",function(){gCompositionChart.selectAll("*").remove();show(gCircles);outsideClick();compositionChartDonutExpanded=false});d3.select("#efsa-pesticide-expanded-circle-rect-close-composition-donut").remove();d3.select("#efsa-pesticide-expanded-circle-rect-close-composition-donut-text").remove()}function showSubcategoryCircleContent(d,color){q.d3stopPropagation();var nsamples=samples["subcat-"+d];var subcategory=d;var category="";for(var i in subcategories){if(subcategories[i].indexOf(subcategory)>-1){category=i;break}}var v1=0;var v2=0;var v3=0;var size=0;_.each(foods,function(food){if(food.subcategory===d){v1+=+food.value_below_loq_as_samples;v2+=+food.value_below_mrl_as_samples;v3+=+food.value_above_mrl_as_samples;size++}});v1=100/nsamples*v1;v2=100/nsamples*v2;v3=100/nsamples*v3;expandHiddenCircle(color,category,subcategory,subcategory,nsamples,v1,v2,v3,SUBCATEGORY)}function showCategoryCircleContent(d,color){q.d3stopPropagation();var nsamples=samples["cat-"+d];var category=d;var v1=0;var v2=0;var v3=0;var size=0;_.each(foods,function(food){if(food.category===d){v1+=+food.value_below_loq_as_samples;v2+=+food.value_below_mrl_as_samples;v3+=+food.value_above_mrl_as_samples;size++}});v1=100/nsamples*v1;v2=100/nsamples*v2;v3=100/nsamples*v3;expandHiddenCircle(color,category,"",category,nsamples,v1,v2,v3,CATEGORY)}}function normalizeFirstLetter(a){if(a[0]===""){a=a.replace("","O")}else if(a[0]===""){a=a.replace("","A")}if(a[1]===""){a=a.replace("","e")}else if(a[1]===""){a=a.replace("","u")}return a}function extractURLLanguage(){var search=window.location.search;if(search){search=search.split("?");if(search.length){search=search[1];if(search){search=search.split("&");for(var i in search){var param=search[i].split("=");if(param[0]==="lang"){return param[1]}}}}}var url=window.location.href;for(var i in LANGUAGES){var LANGUAGE=LANGUAGES[i];if(url.indexOf("/"+LANGUAGE+"/")>0){return LANGUAGE}}return null}var fs=[function(){},doFoods,doCountries];if(window.location.search.indexOf("do=foods")>-1){fs[1]()}else if(window.location.search.indexOf("do=countries")>-1){fs[2]()}else{fs[1]()}}efsaPesticideDataviz(efsaPesticideDatavizConfig);var resize_w=window.innerWidth,resize_h=window.innerHeight;window.addEventListener("resize",function(){if(mobile){var new_resize_w=window.innerWidth;var dw=new_resize_w-resize_w;if(dw){resize_w=new_resize_w;efsaPesticideDataviz(efsaPesticideDatavizConfig);return}var new_resize_h=window.innerHeight;var dh=new_resize_h-resize_h;if(Math.abs(dh)>RESIZE_TOLERANCE){resize_w=new_resize_w;resize_h=new_resize_h;d3.select("#efsa-pesticide-dataviz-svg").attr("viewBox",[0,0,resize_w,resize_h].join(" "));efsaPesticideDataviz(efsaPesticideDatavizConfig);return}setTimeout(function(){var new_resize_h=window.innerHeight;var dh=new_resize_h-resize_h;var dr=new_resize_h/resize_w;var viewBox=d3.select("#efsa-pesticide-dataviz-svg").attr("viewBox").split(" ");if(-dh/dr>=0){viewBox[0]=-dh/dr;viewBox[2]=resize_w+dh/dr;d3.select("#efsa-pesticide-dataviz-svg").attr("viewBox",viewBox.join(" "))}},500);return}else{efsaPesticideDataviz(efsaPesticideDatavizConfig);return}});
